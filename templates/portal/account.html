{% extends "portal/base.html" %}

{% block title %}Compte{% endblock %}

{% block content %}
  <style>
    .portal-tight .portal-card { margin-bottom: 10px; }
    .portal-tight .scan-card { padding: 18px; }
    .portal-section-title { margin-top: 0; margin-bottom: 8px; }
    .portal-grid-2 {
      display: grid;
      gap: 10px 12px;
      grid-template-columns: repeat(2, minmax(180px, 1fr));
    }
    .portal-grid-3 {
      display: grid;
      gap: 10px 12px;
      grid-template-columns: repeat(3, minmax(120px, 1fr));
    }
    .portal-contact-head,
    .portal-contact-row {
      display: grid;
      gap: 8px;
      grid-template-columns: 86px 1fr 1fr 1fr 1.2fr 260px;
      align-items: center;
    }
    .portal-contact-head {
      margin-bottom: 6px;
      font-size: 12px;
      color: #5c6a60;
      font-weight: 600;
    }
    .portal-contact-row {
      margin-bottom: 8px;
    }
    .portal-contact-types {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
    }
    .portal-doc-upload-row {
      display: grid;
      gap: 10px;
      grid-template-columns: minmax(180px, 220px) 1fr;
      align-items: center;
      margin-bottom: 8px;
    }
    .portal-doc-upload-row label {
      margin: 0;
      font-weight: 600;
      color: #32443a;
    }
    @media (max-width: 980px) {
      .portal-contact-head { display: none; }
      .portal-contact-row {
        grid-template-columns: 1fr;
        border: 1px solid #d8e0dc;
        border-radius: 10px;
        padding: 8px;
      }
      .portal-doc-upload-row {
        grid-template-columns: 1fr;
      }
      .portal-grid-2,
      .portal-grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <div class="portal-tight">
    <div class="scan-card portal-card">
      <h2 class="portal-section-title">Compte association</h2>
      <p class="scan-help">Vous pouvez modifier toutes les informations de ce compte.</p>
    </div>

    <div class="scan-card portal-card">
      {% if account_form_errors %}
        <div class="scan-message error">
          {% for error in account_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" novalidate id="portal-account-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_profile">
        <input type="hidden" name="contact_count" id="id_contact_count" value="{{ portal_contact_rows|length }}">

        <h3 class="portal-section-title">Informations principales</h3>
        <div class="portal-grid-2">
          <div class="scan-field">
            <label for="id_association_name">Association</label>
            <input
              type="text"
              id="id_association_name"
              name="association_name"
              value="{{ profile_form_data.association_name }}"
              required
            >
          </div>
          <div class="scan-field">
            <label for="id_association_email">Email</label>
            <input
              type="email"
              id="id_association_email"
              name="association_email"
              value="{{ profile_form_data.association_email }}"
            >
          </div>
          <div class="scan-field">
            <label for="id_association_phone">Téléphone</label>
            <input
              type="text"
              id="id_association_phone"
              name="association_phone"
              value="{{ profile_form_data.association_phone }}"
            >
          </div>
        </div>

        <h3 class="portal-section-title">Adresse</h3>
        <div class="portal-grid-2">
          <div class="scan-field">
            <label for="id_address_line1">Adresse</label>
            <input
              type="text"
              id="id_address_line1"
              name="address_line1"
              value="{{ profile_form_data.address_line1 }}"
              required
            >
          </div>
          <div class="scan-field">
            <label for="id_address_line2">Complément</label>
            <input
              type="text"
              id="id_address_line2"
              name="address_line2"
              value="{{ profile_form_data.address_line2 }}"
            >
          </div>
        </div>
        <div class="portal-grid-3">
          <div class="scan-field">
            <label for="id_postal_code">Code postal</label>
            <input
              type="text"
              id="id_postal_code"
              name="postal_code"
              value="{{ profile_form_data.postal_code }}"
            >
          </div>
          <div class="scan-field">
            <label for="id_city">Ville</label>
            <input
              type="text"
              id="id_city"
              name="city"
              value="{{ profile_form_data.city }}"
            >
          </div>
          <div class="scan-field">
            <label for="id_country">Pays</label>
            <input
              type="text"
              id="id_country"
              name="country"
              value="{{ profile_form_data.country|default:'France' }}"
            >
          </div>
        </div>

        <h3 class="portal-section-title">Contacts emails</h3>
        <p class="scan-help">
          1 ligne = 1 contact. Maximum {{ max_portal_contacts }} lignes. Cochez au moins un type par ligne.
        </p>
        <div class="portal-contact-head">
          <span>Titre</span>
          <span>Nom</span>
          <span>Prénom</span>
          <span>Téléphone</span>
          <span>Mail</span>
          <span>Type</span>
        </div>
        <div id="portal-contact-rows">
          {% for row in portal_contact_rows %}
            <div class="portal-contact-row" data-contact-row="{{ row.index }}">
              <div class="scan-field">
                <select name="contact_{{ row.index }}_title">
                  <option value="">-</option>
                  {% for value, label in contact_title_choices %}
                    <option value="{{ value }}" {% if row.title == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="scan-field">
                <input type="text" name="contact_{{ row.index }}_last_name" value="{{ row.last_name }}" placeholder="Nom">
              </div>
              <div class="scan-field">
                <input type="text" name="contact_{{ row.index }}_first_name" value="{{ row.first_name }}" placeholder="Prénom">
              </div>
              <div class="scan-field">
                <input type="text" name="contact_{{ row.index }}_phone" value="{{ row.phone }}" placeholder="Téléphone">
              </div>
              <div class="scan-field">
                <input type="email" name="contact_{{ row.index }}_email" value="{{ row.email }}" placeholder="email@domaine.org">
              </div>
              <div class="portal-contact-types">
                <label>
                  <input type="checkbox" name="contact_{{ row.index }}_is_administrative" value="1" {% if row.is_administrative %}checked{% endif %}>
                  Administratif
                </label>
                <label>
                  <input type="checkbox" name="contact_{{ row.index }}_is_shipping" value="1" {% if row.is_shipping %}checked{% endif %}>
                  Expédition
                </label>
                <label>
                  <input type="checkbox" name="contact_{{ row.index }}_is_billing" value="1" {% if row.is_billing %}checked{% endif %}>
                  Facturation
                </label>
              </div>
            </div>
          {% endfor %}
        </div>

        <button type="button" class="scan-scan-btn" id="add-contact-row">
          Ajouter un autre contact
        </button>
        <div class="scan-field" style="margin-top: 10px;">
          <button type="submit" class="scan-submit">Enregistrer les modifications</button>
        </div>
      </form>
    </div>

    <div class="scan-card portal-card">
      <h3 class="portal-section-title">Documents de vérification</h3>
      {% if account_documents %}
        <table class="portal-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Statut</th>
              <th>Ajouté le</th>
              <th>Fichier</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in account_documents %}
              <tr>
                <td>{{ doc.get_doc_type_display }}</td>
                <td>{{ doc.get_status_display }}</td>
                <td>{{ doc.uploaded_at|date:"d/m/Y" }}</td>
                <td>
                  {% if doc.file %}
                    <a href="{{ doc.file.url }}" target="_blank">Télécharger</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Aucun document pour le moment.</p>
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="upload_account_docs">
        {% for value, label in account_doc_types %}
          <div class="portal-doc-upload-row">
            <label for="id_doc_{{ value }}">{{ label }}</label>
            <input type="file" id="id_doc_{{ value }}" name="doc_file_{{ value }}">
          </div>
        {% endfor %}
        <button type="submit" class="scan-submit">Ajouter les documents</button>
      </form>
    </div>
  </div>

  <script>
    (function() {
      const rowsContainer = document.getElementById("portal-contact-rows");
      const addButton = document.getElementById("add-contact-row");
      const countInput = document.getElementById("id_contact_count");
      const maxRows = {{ max_portal_contacts }};
      if (!rowsContainer || !addButton || !countInput) {
        return;
      }

      const titleChoicesHtml = `
        <option value="">-</option>
        {% for value, label in contact_title_choices %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      `;

      const updateCount = () => {
        const count = rowsContainer.querySelectorAll("[data-contact-row]").length;
        countInput.value = count;
        addButton.disabled = count >= maxRows;
      };

      addButton.addEventListener("click", () => {
        const count = rowsContainer.querySelectorAll("[data-contact-row]").length;
        if (count >= maxRows) {
          return;
        }
        const row = document.createElement("div");
        row.className = "portal-contact-row";
        row.setAttribute("data-contact-row", String(count));
        row.innerHTML = `
          <div class="scan-field">
            <select name="contact_${count}_title">
              ${titleChoicesHtml}
            </select>
          </div>
          <div class="scan-field">
            <input type="text" name="contact_${count}_last_name" placeholder="Nom">
          </div>
          <div class="scan-field">
            <input type="text" name="contact_${count}_first_name" placeholder="Prénom">
          </div>
          <div class="scan-field">
            <input type="text" name="contact_${count}_phone" placeholder="Téléphone">
          </div>
          <div class="scan-field">
            <input type="email" name="contact_${count}_email" placeholder="email@domaine.org">
          </div>
          <div class="portal-contact-types">
            <label>
              <input type="checkbox" name="contact_${count}_is_administrative" value="1">
              Administratif
            </label>
            <label>
              <input type="checkbox" name="contact_${count}_is_shipping" value="1">
              Expédition
            </label>
            <label>
              <input type="checkbox" name="contact_${count}_is_billing" value="1">
              Facturation
            </label>
          </div>
        `;
        rowsContainer.appendChild(row);
        updateCount();
      });

      updateCount();
    })();
  </script>
{% endblock %}
