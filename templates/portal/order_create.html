{% extends "portal/base.html" %}

{% block title %}Nouvelle commande{% endblock %}

{% block content %}
  <div class="scan-card portal-card">
    <h2>Nouvelle commande</h2>
    <p class="scan-help">Selectionnez un destinataire puis indiquez les quantites.</p>
  </div>

  <div class="scan-card portal-card">
    {% if errors %}
      <div class="scan-message error">
        {% for error in errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="scan-field">
        <label for="recipient_id">Destinataire</label>
        <select id="recipient_id" name="recipient_id" required>
          {% for option in recipient_options %}
            <option value="{{ option.id }}" {% if option.id|stringformat:"s" == form_data.recipient_id %}selected{% endif %}>
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
        <p class="scan-help">
          Besoin d'un nouveau destinataire ?
          <a href="{% url 'portal:portal_recipients' %}">Ajouter</a>
        </p>
      </div>

      <div class="scan-field">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3">{{ form_data.notes }}</textarea>
      </div>

      <div class="scan-field">
        <label>Produits</label>
        <table class="portal-table">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Stock</th>
              <th>Quantite</th>
              <th>Cartons estimes</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
              <tr>
                <td>{{ product.name }}</td>
                <td>{{ product.available_stock }}</td>
                <td>
                  <input
                    type="number"
                    name="product_{{ product.id }}_qty"
                    min="0"
                    value="{{ product.quantity }}"
                    {% if product.available_stock == 0 %}disabled{% endif %}
                  >
                  {% if line_errors %}
                    {% for pid, error in line_errors.items %}
                      {% if pid == product.id|stringformat:"s" %}
                        <div class="scan-message error">{{ error }}</div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td>
                  {% if product.estimate %}
                    {{ product.estimate }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if total_estimated_cartons %}
          <p class="scan-help">Total estime: {{ total_estimated_cartons }} carton(s).</p>
        {% endif %}
      </div>

      <button type="submit" class="scan-submit">Envoyer la commande</button>
    </form>
  </div>
{% endblock %}
