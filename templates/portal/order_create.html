{% extends "portal/base.html" %}

{% block title %}Nouvelle commande{% endblock %}

{% block content %}
  <div class="scan-card portal-card">
    <h2>Nouvelle commande</h2>
    <p class="scan-help">S&eacute;lectionnez une destination, puis un destinataire, puis indiquez les quantit&eacute;s.</p>
  </div>

  <div class="scan-card portal-card">
    {% if errors %}
      <div class="scan-message error">
        {% for error in errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="scan-field">
        <label for="destination_id">Destination</label>
        <select id="destination_id" name="destination_id" required>
          <option value="">---------</option>
          {% for option in destination_options %}
            <option value="{{ option.id }}" {% if option.id|stringformat:"s" == form_data.destination_id %}selected{% endif %}>
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="scan-field">
        <label for="recipient_id">Destinataire</label>
        <select id="recipient_id" name="recipient_id" required>
          <option value="">---------</option>
          {% for option in recipient_options %}
            <option value="{{ option.id }}" {% if option.id|stringformat:"s" == form_data.recipient_id %}selected{% endif %}>
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
        <p class="scan-help">
          Le destinataire est filtr&eacute; selon la destination choisie.
        </p>
        <p class="scan-help">
          Besoin d'un nouveau destinataire ?
          <a href="{% url 'portal:portal_recipients' %}">Ajouter</a>
        </p>
      </div>

      <div class="scan-field">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3">{{ form_data.notes }}</textarea>
      </div>

      <div class="scan-field">
        <label>Colis disponibles</label>
        <div class="portal-products-panel">
          <div class="scan-table-wrap portal-products-table-wrap">
            <table class="scan-table portal-table" data-table-tools="1">
              <thead>
                <tr>
                  <th>Produit</th>
                  <th>Stock</th>
                  <th>Quantit&eacute;</th>
                  <th>Date de p&eacute;remption</th>
                </tr>
              </thead>
              <tbody>
                {% for row in ready_cartons %}
                  <tr
                    data-ready-carton-key="{{ row.row_key }}"
                    data-ready-carton-stock="{{ row.available_stock }}"
                  >
                    <td>
                      {% for line in row.product_lines %}
                        <div>{{ line.product_name }} - {{ line.quantity }} unit&eacute;s</div>
                      {% endfor %}
                    </td>
                    <td>{{ row.available_stock }}</td>
                    <td>
                      <input
                        type="number"
                        name="ready_carton_{{ row.row_key }}_qty"
                        min="0"
                        value="{{ row.quantity }}"
                        {% if row.available_stock == 0 %}disabled{% endif %}
                      >
                      {% if row.line_error %}
                        <div class="scan-message error">{{ row.line_error }}</div>
                      {% endif %}
                    </td>
                    <td>{% if row.expires_on %}{{ row.expires_on|date:"d/m/Y" }}{% endif %}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="4">Aucun colis pr&ecirc;t disponible.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="scan-field">
        <label>Produits &agrave; l'unit&eacute;</label>
        <p class="scan-help">
          Les stock indiqu&eacute;s dans ce tableau sont fictifs. Cette fonctionnalit&eacute; sera bient&ocirc;t activ&eacute;e pour afficher les stocks r&eacute;els.
        </p>
        <div class="portal-products-panel">
          <div class="scan-table-wrap portal-products-table-wrap">
            <table class="scan-table portal-table" data-table-tools="1">
              <thead>
                <tr>
                  <th>Produit</th>
                  <th>Stock</th>
                  <th>Quantit&eacute;</th>
                  <th>Cartons estim&eacute;s</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                  <tr data-product-id="{{ product.id }}">
                    <td>{{ product.name }}</td>
                    <td>{{ product.available_stock }}</td>
                    <td>
                      <input
                        type="number"
                        name="product_{{ product.id }}_qty"
                        min="0"
                        value="{{ product.quantity }}"
                        {% if product.available_stock == 0 %}disabled{% endif %}
                      >
                      {% if line_errors %}
                        {% for pid, error in line_errors.items %}
                          {% if pid == product.id|stringformat:"s" %}
                            <div class="scan-message error">{{ error }}</div>
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </td>
                    <td class="carton-estimate">
                      {% if product.estimate %}
                        {{ product.estimate }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="portal-products-actions">
            <p class="scan-help">
              Total estim&eacute;:
              <span id="ready-carton-estimate-total">{{ total_selected_ready_cartons|default:0 }}</span>
              colis pr&ecirc;ts + <span id="carton-estimate-total">{% if total_estimated_cartons_to_prepare %}{{ total_estimated_cartons_to_prepare }}{% else %}0{% endif %}</span>
              carton(s) &agrave; pr&eacute;parer.
            </p>
            <button type="submit" class="scan-submit">Envoyer la commande</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  {{ recipient_options_all|json_script:"portal-recipient-options-data" }}
  {{ product_data|json_script:"portal-product-data" }}
  {% if carton_format %}
    {{ carton_format|json_script:"portal-carton-data" }}
  {% endif %}

  <script>
    (function() {
      const destinationSelect = document.getElementById('destination_id');
      const recipientSelect = document.getElementById('recipient_id');
      const recipientOptionsEl = document.getElementById('portal-recipient-options-data');
      let recipientOptions = [];
      try {
        recipientOptions = JSON.parse(recipientOptionsEl ? recipientOptionsEl.textContent || '[]' : '[]');
      } catch (err) {
        recipientOptions = [];
      }

      const normalizeId = value => (value || value === 0 ? String(value).trim() : '');
      const sortByLabel = options =>
        [...options].sort((left, right) =>
          String(left.label || '').localeCompare(String(right.label || ''), 'fr', {
            sensitivity: 'base'
          })
        );
      const renderRecipientOptions = () => {
        if (!destinationSelect || !recipientSelect) {
          return;
        }
        const selectedDestinationId = normalizeId(destinationSelect.value);
        const selectedRecipientId = normalizeId(recipientSelect.value);
        const filteredOptions = sortByLabel(
          recipientOptions.filter(option => {
            const optionId = normalizeId(option.id);
            if (!optionId) {
              return false;
            }
            if (!selectedDestinationId) {
              return optionId === 'self';
            }
            const optionDestinationId = normalizeId(option.destination_id);
            return (
              optionId === 'self' ||
              !optionDestinationId ||
              optionDestinationId === selectedDestinationId
            );
          })
        );

        recipientSelect.innerHTML = '';
        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '---------';
        recipientSelect.appendChild(empty);

        filteredOptions.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = String(option.id);
          optionEl.textContent = option.label;
          recipientSelect.appendChild(optionEl);
        });

        recipientSelect.disabled = !selectedDestinationId;
        if (
          selectedRecipientId &&
          filteredOptions.some(option => normalizeId(option.id) === selectedRecipientId)
        ) {
          recipientSelect.value = selectedRecipientId;
        } else {
          recipientSelect.value = '';
        }
      };
      if (destinationSelect && recipientSelect) {
        destinationSelect.addEventListener('change', renderRecipientOptions);
        renderRecipientOptions();
      }

      const cartonDataEl = document.getElementById('portal-carton-data');
      const carton = cartonDataEl ? JSON.parse(cartonDataEl.textContent || 'null') : null;
      const productDataEl = document.getElementById('portal-product-data');
      let products = [];
      try {
        products = JSON.parse(productDataEl ? productDataEl.textContent || '[]' : '[]');
      } catch (err) {
        products = [];
      }

      const productMap = new Map();
      products.forEach(product => {
        if (product && product.id) {
          productMap.set(String(product.id), product);
        }
      });

      const parseNumber = value => {
        const parsed = parseFloat((value || '').toString().replace(',', '.'));
        return Number.isFinite(parsed) ? parsed : null;
      };

      const getProductVolume = product => {
        if (!product) {
          return null;
        }
        if (product.volume_cm3) {
          return parseNumber(product.volume_cm3);
        }
        const length = parseNumber(product.length_cm);
        const width = parseNumber(product.width_cm);
        const height = parseNumber(product.height_cm);
        if (length && width && height) {
          return length * width * height;
        }
        return null;
      };

      const computeMaxUnits = (product, carton) => {
        if (!product || !carton) {
          return null;
        }
        const cartonVolume =
          carton.length_cm && carton.width_cm && carton.height_cm
            ? carton.length_cm * carton.width_cm * carton.height_cm
            : null;
        const productVolume = getProductVolume(product);
        let maxByVolume = null;
        if (cartonVolume && productVolume && productVolume > 0) {
          maxByVolume = Math.floor(cartonVolume / productVolume);
          if (maxByVolume < 1) {
            maxByVolume = 1;
          }
        }
        let maxByWeight = null;
        const weight = parseNumber(product.weight_g);
        if (weight && carton.max_weight_g) {
          maxByWeight = Math.floor(carton.max_weight_g / weight);
          if (maxByWeight < 1) {
            maxByWeight = 1;
          }
        }
        if (maxByVolume && maxByWeight) {
          return Math.min(maxByVolume, maxByWeight);
        }
        return maxByVolume || maxByWeight;
      };

      const rows = Array.from(document.querySelectorAll('tr[data-product-id]'));
      const readyRows = Array.from(document.querySelectorAll('tr[data-ready-carton-key]'));
      const totalEl = document.getElementById('carton-estimate-total');
      const readyTotalEl = document.getElementById('ready-carton-estimate-total');

      const updateRow = row => {
        const productId = row.dataset.productId;
        const product = productMap.get(productId);
        const input = row.querySelector('input[type="number"]');
        const estimateEl = row.querySelector('.carton-estimate');
        const qty = parseInt(input && input.value ? input.value : '0', 10) || 0;
        const maxUnits = computeMaxUnits(product, carton);
        if (!qty) {
          estimateEl.textContent = '-';
          return 0;
        }
        if (!maxUnits) {
          estimateEl.textContent = 'N/A';
          return 0;
        }
        const estimate = Math.ceil(qty / maxUnits);
        estimateEl.textContent = estimate;
        return estimate;
      };

      const updateTotals = () => {
        let total = 0;
        rows.forEach(row => {
          total += updateRow(row);
        });
        if (totalEl) {
          totalEl.textContent = String(total);
        }
        if (readyTotalEl) {
          let readyTotal = 0;
          readyRows.forEach(row => {
            const input = row.querySelector('input[type="number"]');
            if (!input) {
              return;
            }
            const qty = parseInt(input.value || '0', 10);
            const available = parseInt(row.dataset.readyCartonStock || '0', 10);
            if (!Number.isFinite(qty) || qty <= 0) {
              return;
            }
            if (Number.isFinite(available) && qty > available) {
              return;
            }
            readyTotal += qty;
          });
          readyTotalEl.textContent = String(readyTotal);
        }
      };

      rows.forEach(row => {
        const input = row.querySelector('input[type="number"]');
        if (input) {
          input.addEventListener('input', updateTotals);
        }
      });
      readyRows.forEach(row => {
        const input = row.querySelector('input[type="number"]');
        if (input) {
          input.addEventListener('input', updateTotals);
        }
      });
      updateTotals();
    })();
  </script>
{% endblock %}
