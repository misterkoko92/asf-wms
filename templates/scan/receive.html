{% extends "scan/base.html" %}

{% block title %}WMS Scan - R&eacute;ception{% endblock %}

{% block content %}
  <div class="scan-card card border-0">
    <h2>R&eacute;ception don/palette</h2>
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="select_receipt">
      <div class="scan-field">
        <label class="form-label" for="id_receipt">R&eacute;ception existante</label>
        <div class="scan-inline">
          {{ select_form.receipt }}
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_receipt_add' %}" target="_blank" rel="noopener">
            Ajouter r&eacute;ception
          </a>
        </div>
        {% for error in select_form.receipt.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>
      <button type="submit" class="scan-submit secondary scan-submit-inline btn btn-secondary">Ouvrir r&eacute;ception</button>
    </form>

    <div class="scan-divider"></div>

    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="create_receipt">
      <div class="scan-field">
        <label class="form-label" for="id_receipt_type">Type r&eacute;ception</label>
        {{ create_form.receipt_type }}
        {% for error in create_form.receipt_type.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_source_contact">Provenance</label>
        <div class="scan-inline">
          {{ create_form.source_contact }}
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
            Ajouter provenance
          </a>
        </div>
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_carrier_contact">Transporteur</label>
        <div class="scan-inline">
          {{ create_form.carrier_contact }}
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
            Ajouter transporteur
          </a>
        </div>
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_origin_reference">R&eacute;f&eacute;rence provenance</label>
        {{ create_form.origin_reference }}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_carrier_reference">R&eacute;f&eacute;rence transport</label>
        {{ create_form.carrier_reference }}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_received_on">Date r&eacute;ception</label>
        {{ create_form.received_on }}
        {% for error in create_form.received_on.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_warehouse">Entrep&ocirc;t</label>
        <div class="scan-inline">
          {{ create_form.warehouse }}
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_warehouse_add' %}" target="_blank" rel="noopener">
            Ajouter entrep&ocirc;t
          </a>
        </div>
        {% for error in create_form.warehouse.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_notes">Notes</label>
        {{ create_form.notes }}
      </div>

      <button type="submit" class="scan-submit btn btn-primary">Cr&eacute;er r&eacute;ception</button>
      <p class="scan-help">Contacts g&eacute;r&eacute;s dans l'admin.</p>
    </form>
  </div>

  {% if selected_receipt %}
    <div class="scan-card card border-0">
      <h2>R&eacute;ception active</h2>
      <div class="scan-meta-grid">
        <div class="scan-meta-item">
          <strong>R&eacute;f&eacute;rence</strong>
          {{ selected_receipt.reference|default:"-" }}
        </div>
        <div class="scan-meta-item">
          <strong>Type</strong>
          {{ selected_receipt.get_receipt_type_display }}
        </div>
        <div class="scan-meta-item">
          <strong>Statut</strong>
          {{ selected_receipt.get_status_display }}
        </div>
        <div class="scan-meta-item">
          <strong>Date r&eacute;ception</strong>
          {{ selected_receipt.received_on|date:"d/m/Y" }}
        </div>
        <div class="scan-meta-item">
          <strong>Entrep&ocirc;t</strong>
          {{ selected_receipt.warehouse }}
        </div>
        <div class="scan-meta-item">
          <strong>Provenance</strong>
          {{ selected_receipt.source_contact|default:"-" }}
        </div>
        <div class="scan-meta-item">
          <strong>Transporteur</strong>
          {{ selected_receipt.carrier_contact|default:"-" }}
        </div>
      </div>
    </div>

    <div class="scan-card card border-0">
      <h2>Ajouter une ligne</h2>
      {% if line_form.non_field_errors %}
        <div class="scan-message error">{{ line_form.non_field_errors }}</div>
      {% endif %}
      <form method="post" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="add_line">
        {{ line_form.receipt_id }}

        <div class="scan-field">
          <label class="form-label" for="id_product_code">Code produit</label>
          <div class="scan-inline">
            {{ line_form.product_code }}
            <button type="button" class="scan-scan-btn btn btn-outline-primary" data-scan-target="id_product_code">Scan</button>
          </div>
          {% for error in line_form.product_code.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
          {% if "Produit introuvable." in line_form.product_code.errors %}
            <a class="scan-submit secondary btn btn-secondary" href="{% url 'admin:wms_product_add' %}">Ajouter un nouveau produit</a>
          {% endif %}
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_quantity">Quantit&eacute;</label>
          {{ line_form.quantity }}
          {% for error in line_form.quantity.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_lot_code">Lot</label>
          {{ line_form.lot_code }}
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_expires_on">Date p&eacute;remption</label>
          {{ line_form.expires_on }}
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_lot_status">Statut lot</label>
          {{ line_form.lot_status }}
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_location">Emplacement</label>
          <div class="scan-inline">
            {{ line_form.location }}
            <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_location_add' %}" target="_blank" rel="noopener">
              Ajouter emplacement
            </a>
          </div>
          {% for error in line_form.location.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
          <p class="scan-help">Laissez vide pour utiliser l'emplacement par d&eacute;faut du produit.</p>
        </div>

        <div class="scan-field">
          <label class="form-label" for="id_storage_conditions">Conditions stockage</label>
          {{ line_form.storage_conditions }}
        </div>

        <div class="scan-field">
          <label class="form-label">
            {{ line_form.receive_now }}
            R&eacute;ceptionner maintenant
          </label>
        </div>

        <button type="submit" class="scan-submit btn btn-primary">Ajouter la ligne</button>
        <p class="scan-help">Astuce: le statut auto applique la quarantaine par d&eacute;faut du produit.</p>
      </form>
      {{ products_json|json_script:"product-data" }}
      <datalist id="product-options">
        {% for product in products_json %}
          <option value="{{ product.name }}" label="{{ product.sku }}{% if product.barcode %} | {{ product.barcode }}{% endif %}{% if product.ean %} | {{ product.ean }}{% endif %}"></option>
        {% endfor %}
      </datalist>
    </div>

    <div class="scan-card card border-0">
      <h2>Lignes de r&eacute;ception</h2>
      {% if receipt_lines %}
        <div class="scan-table-wrap table-responsive">
          <table class="scan-table table table-sm table-hover">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Quantit&eacute;</th>
                <th>Lot</th>
                <th>Peremption</th>
                <th>Emplacement</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              {% for line in receipt_lines %}
                <tr>
                  <td>{{ line.product.name }}</td>
                  <td class="qty">{{ line.quantity }}</td>
                  <td>{{ line.lot_code|default:"-" }}</td>
                  <td>{% if line.expires_on %}{{ line.expires_on|date:"d/m/Y" }}{% else %}-{% endif %}</td>
                  <td>{{ line.location|default:"-" }}</td>
                  <td class="status">
                    {% if line.received_lot_id %}
                      R&eacute;ceptionn&eacute;
                    {% else %}
                      En attente
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if pending_count %}
          <form method="post" class="scan-field">
            {% csrf_token %}
            <input type="hidden" name="action" value="receive_lines">
            <input type="hidden" name="receipt_id" value="{{ selected_receipt.id }}">
            <button type="submit" class="scan-submit secondary scan-submit-inline btn btn-secondary">
              R&eacute;ceptionner {{ pending_count }} ligne(s)
            </button>
          </form>
        {% endif %}
      {% else %}
        <p class="scan-help">Aucune ligne pour cette r&eacute;ception.</p>
      {% endif %}
    </div>
  {% else %}
    <div class="scan-card card border-0">
      <h2>Aucune r&eacute;ception s&eacute;lectionn&eacute;e</h2>
      <p class="scan-help">Cr&eacute;ez une r&eacute;ception ou s&eacute;lectionnez-en une pour ajouter des lignes.</p>
    </div>
  {% endif %}
{% endblock %}
