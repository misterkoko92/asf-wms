{% extends "scan/base.html" %}

{% block title %}WMS Scan - Pr&eacute;paration{% endblock %}

{% block content %}
  {% if packing_result %}
    <div class="scan-card card border-0">
      <h2>Liste de colisage</h2>
      <h3 class="scan-subtitle">Par carton</h3>
      {% for carton in packing_result.cartons %}
        <div class="pack-list">
          <div class="scan-inline scan-inline-gap">
            <strong>Carton {{ carton.code }}</strong>
            <div class="scan-inline-actions">
              <a class="scan-scan-btn btn btn-outline-primary" href="{{ carton.packing_list_url }}" target="_blank" rel="noopener">
                Imprimer / télécharger
              </a>
              <a class="scan-scan-btn btn btn-outline-primary" href="{{ carton.picking_url }}" target="_blank" rel="noopener">
                Picking
              </a>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Produit</th>
                <th>Quantit&eacute;</th>
              </tr>
            </thead>
            <tbody>
              {% for item in carton.items %}
                <tr>
                  <td>{{ item.label }}</td>
                  <td>{{ item.quantity }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}

      <h3 class="scan-subtitle">Liste generale</h3>
      <div class="pack-list">
        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Quantit&eacute;</th>
            </tr>
          </thead>
          <tbody>
            {% for item in packing_result.aggregate %}
              <tr>
                <td>{{ item.label }}</td>
                <td>{{ item.quantity }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
  <div class="scan-card card border-0">
    <h2>Pr&eacute;paration cartons</h2>
    {% if form.non_field_errors %}
      <div class="scan-message error">{{ form.non_field_errors }}</div>
    {% endif %}
    <form method="post" novalidate>
      {% csrf_token %}

      <div class="scan-field">
        <label class="form-label" for="id_carton_format">Format carton</label>
        <div class="scan-inline">
          <select id="id_carton_format" name="carton_format_id">
            {% for format in carton_formats %}
              {% with format_id=format.id|stringformat:"s" %}
                <option value="{{ format.id }}" {% if format_id == carton_format_id %}selected{% endif %}>
                  {{ format.name }} ({{ format.length_cm }}x{{ format.width_cm }}x{{ format.height_cm }} cm, {{ format.max_weight_g }} g)
                </option>
              {% endwith %}
            {% endfor %}
            <option value="custom" {% if carton_format_id == "custom" %}selected{% endif %}>Personnalisé</option>
          </select>
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_cartonformat_add' %}" target="_blank" rel="noopener">
            Ajouter format
          </a>
        </div>
      </div>

      <div id="custom-carton-fields" class="scan-field">
        <label class="form-label">Dimensions carton (cm) et poids max (g)</label>
        <div class="scan-inline scan-inline-equal">
          <input type="number" step="0.01" name="carton_length_cm" id="id_carton_length_cm" placeholder="Longueur" value="{{ carton_custom.length_cm }}">
          <input type="number" step="0.01" name="carton_width_cm" id="id_carton_width_cm" placeholder="Largeur" value="{{ carton_custom.width_cm }}">
        </div>
        <div class="scan-inline scan-inline-equal scan-inline-gap">
          <input type="number" step="0.01" name="carton_height_cm" id="id_carton_height_cm" placeholder="Hauteur" value="{{ carton_custom.height_cm }}">
          <input type="number" step="1" name="carton_max_weight_g" id="id_carton_max_weight_g" placeholder="Poids max" value="{{ carton_custom.max_weight_g }}">
        </div>
      </div>

      <div class="pack-lines" id="pack-lines"></div>
      <button type="button" class="scan-submit secondary btn btn-secondary" id="pack-add-line">+ Ajouter un produit</button>
      <input type="hidden" id="pack_line_count" name="line_count" value="{{ line_count }}">

      <div class="scan-field scan-field-gap">
        <label class="form-label" for="id_shipment_reference">Référence expédition (optionnel)</label>
        <div class="scan-inline">
          {{ form.shipment_reference }}
          <button type="button" class="scan-scan-btn btn btn-outline-primary" data-scan-target="id_shipment_reference">Scan</button>
        </div>
        {% for error in form.shipment_reference.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label class="form-label" for="id_current_location">Choisir un emplacement de rangement du colis prêt (optionnel)</label>
        <div class="scan-inline">
          {{ form.current_location }}
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_location_add' %}" target="_blank" rel="noopener">
            Ajouter emplacement
          </a>
        </div>
      </div>

      {% if missing_defaults %}
        <div class="scan-message warning">
          Attention : les produits suivants n'ont pas de dimensions ni de poids enregistr&eacute;s :
          {{ missing_defaults|join:", " }}.
          Si vous validez ces ajouts, des valeurs par d&eacute;faut seront appliqu&eacute;es (1cm x 1cm x 1cm et 5g).
        </div>
      {% endif %}
      <div class="scan-field">
        <label class="scan-switch-row">
          <input type="checkbox" name="confirm_defaults" value="1" {% if confirm_defaults %}checked{% endif %}>
          <span class="scan-switch" aria-hidden="true">
            <span class="scan-switch-icon scan-switch-icon-off">x</span>
            <span class="scan-switch-icon scan-switch-icon-on">OK</span>
            <span class="scan-switch-knob"></span>
          </span>
          <span class="scan-switch-text">Valider les ajouts avec dimensions/poids par d&eacute;faut si n&eacute;cessaire.</span>
        </label>
      </div>

      <button type="submit" class="scan-submit btn btn-primary">Pr&eacute;parer</button>
      <p class="scan-help">Si la référence d'expédition est vide, les cartons sont pré-conditionnés.</p>
    </form>
    {{ products_json|json_script:"product-data" }}
    {{ carton_formats|json_script:"carton-format-data" }}
    {{ line_values|json_script:"pack-lines-data" }}
    {{ line_errors|json_script:"pack-lines-errors" }}
    <datalist id="product-options">
      {% for product in products_json %}
        <option value="{{ product.name }}" label="{{ product.sku }}{% if product.barcode %} | {{ product.barcode }}{% endif %}{% if product.ean %} | {{ product.ean }}{% endif %}"></option>
      {% endfor %}
    </datalist>
  </div>
{% endblock %}
