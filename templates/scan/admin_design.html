{% extends "scan/base.html" %}

{% block title %}WMS Scan - Admin Design{% endblock %}

{% block extra_head %}
  <style>
    .scan-design-editor-card {
      overflow: visible !important;
    }

    .scan-design-form {
      grid-template-columns: minmax(0, 1fr) !important;
    }

    .scan-design-form > * {
      grid-column: 1 / -1 !important;
    }

    .scan-design-section-title {
      margin: 0 0 0.6rem;
    }

    .scan-design-switch {
      border: 1px solid var(--preview-border, #d9e2dc);
      border-radius: 0.75rem;
      background: var(--preview-surface, #fffdf9);
      padding: 0.8rem 0.9rem;
    }

    .scan-design-switch .form-check-label {
      font-weight: 700;
      color: var(--preview-text, #2f3a36);
    }

    .scan-design-font-grid {
      display: grid;
      gap: 0.9rem;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      align-items: start;
    }

    .scan-design-font-grid .scan-field {
      margin-bottom: 0;
      min-width: 0;
    }

    .scan-design-font-grid .scan-field select {
      min-height: 42px;
    }

    .scan-design-color-scroll {
      width: 100%;
      min-width: 0;
      overflow-x: auto;
      padding-bottom: 0.2rem;
    }

    .scan-design-color-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(7, minmax(128px, 1fr));
      min-width: 900px;
      align-items: start;
    }

    .scan-design-color-field {
      margin-bottom: 0;
      min-width: 0;
    }

    .scan-design-color-field .scan-help {
      margin-top: 0.45rem;
    }

    .scan-design-color-preview {
      height: 62px;
      border-radius: 0.7rem;
      border: 1px solid var(--preview-border, #d9e2dc);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.34);
      margin-bottom: 0.55rem;
      transition: background-color 0.14s ease;
    }

    .scan-design-color-input-row {
      display: grid;
      grid-template-columns: 44px minmax(0, 1fr);
      align-items: center;
      gap: 0.4rem;
    }

    .scan-design-color-input {
      width: 44px;
      min-width: 44px;
      height: 34px;
      padding: 0.18rem;
      border-radius: 0.7rem;
      border: 1px solid var(--preview-border, #d9e2dc);
      background: #fff;
      cursor: pointer;
    }

    .scan-design-color-input::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .scan-design-color-input::-webkit-color-swatch,
    .scan-design-color-input::-moz-color-swatch {
      border: 0;
      border-radius: 0.5rem;
    }

    .scan-design-color-code {
      display: block;
      width: 100%;
      min-width: 0;
      padding: 0.21rem 0.4rem;
      border-radius: 0.45rem;
      border: 1px solid var(--preview-border, #d9e2dc);
      background: var(--preview-surface, #fffdf9);
      color: var(--preview-text, #2f3a36);
      font-size: 0.8rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .scan-design-preview {
      border: 1px solid var(--preview-border, #d9e2dc);
      border-radius: 0.9rem;
      background: var(--preview-bg, #f6f8f5);
      color: var(--preview-text, #2f3a36);
      padding: 0.95rem;
    }

    .scan-design-preview .preview-surface {
      border: 1px solid var(--preview-border, #d9e2dc);
      border-radius: 0.78rem;
      background: var(--preview-surface, #fffdf9);
      padding: 0.78rem;
      margin-bottom: 0.7rem;
    }

    .scan-design-preview h4,
    .scan-design-preview h5 {
      margin: 0 0 0.45rem;
    }

    .scan-design-preview h4 {
      font-family: var(--preview-font-h2, "DM Sans", sans-serif);
    }

    .scan-design-preview h5 {
      font-family: var(--preview-font-h3, "DM Sans", sans-serif);
    }

    .scan-design-preview p,
    .scan-design-preview li {
      margin: 0;
      font-family: var(--preview-font-body, "Nunito Sans", sans-serif);
      color: var(--preview-text-soft, #5a6964);
    }

    .scan-design-preview .preview-kpi {
      display: inline-block;
      margin-right: 0.45rem;
      margin-bottom: 0.4rem;
      padding: 0.34rem 0.58rem;
      border-radius: 999px;
      border: 1px solid var(--preview-border, #d9e2dc);
      background: var(--preview-surface, #fffdf9);
      font-family: var(--preview-font-body, "Nunito Sans", sans-serif);
      color: var(--preview-text, #2f3a36);
    }

    .scan-design-preview .preview-button {
      display: inline-block;
      border: 0;
      border-radius: 0.6rem;
      padding: 0.44rem 0.7rem;
      margin-right: 0.4rem;
      margin-bottom: 0.4rem;
      font-family: var(--preview-font-h2, "DM Sans", sans-serif);
      font-weight: 700;
      color: #fff;
      background: var(--preview-primary, #6f9a8d);
    }

    .scan-design-preview .preview-button.secondary {
      background: var(--preview-secondary, #e7c3a8);
      color: var(--preview-text, #2f3a36);
    }

    @media (max-width: 1100px) {
      .scan-design-font-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 768px) {
      .scan-design-font-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="scan-card card border-0 ui-comp-card">
    <h2 class="ui-comp-title">Admin - Design</h2>
    <p class="scan-help ui-comp-note">
      Cette page est réservée aux superusers. Vous pouvez modifier les variables visuelles globales
      (couleurs, typos et options runtime), appliquées sur les pages scan/portal/home/login/admin personnalisés.
    </p>
    <p class="scan-help ui-comp-note">
      Ce panneau sera enrichi progressivement avec davantage de variables pilotables directement depuis le site.
    </p>
  </div>

  <div class="scan-card card border-0 ui-comp-card scan-design-editor-card">
    <form method="post" class="scan-filters ui-comp-form scan-design-form">
      {% csrf_token %}

      <h3 class="scan-design-section-title">Activation globale Bootstrap</h3>
      <div class="scan-design-switch">
        <div class="form-check form-switch">
          {{ form.scan_bootstrap_enabled }}
          <label class="form-check-label" for="{{ form.scan_bootstrap_enabled.id_for_label }}">
            {{ form.scan_bootstrap_enabled.label }}
          </label>
        </div>
        <div class="scan-help">{{ form.scan_bootstrap_enabled.help_text }}</div>
        {% if form.scan_bootstrap_enabled.errors %}
          <div class="scan-help">{{ form.scan_bootstrap_enabled.errors|join:", " }}</div>
        {% endif %}
      </div>

      <div class="scan-divider"></div>

      <h3 class="scan-design-section-title">Typographies</h3>
      <div class="scan-design-font-grid">
        <div class="scan-field">
          {{ form.design_font_h1.label_tag }}
          {{ form.design_font_h1 }}
          {% if form.design_font_h1.errors %}<div class="scan-help">{{ form.design_font_h1.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_font_h1.help_text }}</div>
        </div>
        <div class="scan-field">
          {{ form.design_font_h2.label_tag }}
          {{ form.design_font_h2 }}
          {% if form.design_font_h2.errors %}<div class="scan-help">{{ form.design_font_h2.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_font_h2.help_text }}</div>
        </div>
        <div class="scan-field">
          {{ form.design_font_h3.label_tag }}
          {{ form.design_font_h3 }}
          {% if form.design_font_h3.errors %}<div class="scan-help">{{ form.design_font_h3.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_font_h3.help_text }}</div>
        </div>
        <div class="scan-field">
          {{ form.design_font_body.label_tag }}
          {{ form.design_font_body }}
          {% if form.design_font_body.errors %}<div class="scan-help">{{ form.design_font_body.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_font_body.help_text }}</div>
        </div>
      </div>

      <div class="scan-divider"></div>

      <h3 class="scan-design-section-title">Couleurs</h3>
      <div class="scan-design-color-scroll">
      <div class="scan-design-color-grid">
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_primary.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_primary.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_primary }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_primary.id_for_label }}"></code>
          </div>
          {% if form.design_color_primary.errors %}<div class="scan-help">{{ form.design_color_primary.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_primary.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_secondary.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_secondary.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_secondary }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_secondary.id_for_label }}"></code>
          </div>
          {% if form.design_color_secondary.errors %}<div class="scan-help">{{ form.design_color_secondary.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_secondary.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_background.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_background.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_background }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_background.id_for_label }}"></code>
          </div>
          {% if form.design_color_background.errors %}<div class="scan-help">{{ form.design_color_background.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_background.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_surface.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_surface.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_surface }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_surface.id_for_label }}"></code>
          </div>
          {% if form.design_color_surface.errors %}<div class="scan-help">{{ form.design_color_surface.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_surface.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_border.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_border.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_border }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_border.id_for_label }}"></code>
          </div>
          {% if form.design_color_border.errors %}<div class="scan-help">{{ form.design_color_border.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_border.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_text.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_text.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_text }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_text.id_for_label }}"></code>
          </div>
          {% if form.design_color_text.errors %}<div class="scan-help">{{ form.design_color_text.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_text.help_text }}</div>
        </div>
        <div class="scan-field scan-design-color-field">
          {{ form.design_color_text_soft.label_tag }}
          <div class="scan-design-color-preview" data-color-swatch-for="{{ form.design_color_text_soft.id_for_label }}"></div>
          <div class="scan-design-color-input-row">
            {{ form.design_color_text_soft }}
            <code class="scan-design-color-code" data-color-value-for="{{ form.design_color_text_soft.id_for_label }}"></code>
          </div>
          {% if form.design_color_text_soft.errors %}<div class="scan-help">{{ form.design_color_text_soft.errors|join:", " }}</div>{% endif %}
          <div class="scan-help">{{ form.design_color_text_soft.help_text }}</div>
        </div>
      </div>
      </div>

      {% if form.non_field_errors %}
        <div class="scan-message error">{{ form.non_field_errors|join:", " }}</div>
      {% endif %}

      <div class="scan-filter-actions">
        <button type="submit" name="action" value="save" class="scan-submit btn btn-primary">Enregistrer</button>
        <button type="submit" name="action" value="reset" class="scan-scan-btn btn btn-outline-secondary">Réinitialiser (valeurs recommandées)</button>
      </div>
    </form>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h3>Aperçu rapide</h3>
    <div
      class="scan-design-preview"
      style="
        --preview-primary: {{ preview_values.design_color_primary }};
        --preview-secondary: {{ preview_values.design_color_secondary }};
        --preview-bg: {{ preview_values.design_color_background }};
        --preview-surface: {{ preview_values.design_color_surface }};
        --preview-border: {{ preview_values.design_color_border }};
        --preview-text: {{ preview_values.design_color_text }};
        --preview-text-soft: {{ preview_values.design_color_text_soft }};
        --preview-font-h1: {{ preview_values.design_font_h1 }};
        --preview-font-h2: {{ preview_values.design_font_h2 }};
        --preview-font-h3: {{ preview_values.design_font_h3 }};
        --preview-font-body: {{ preview_values.design_font_body }};
      "
    >
      <div class="preview-surface">
        <h4>Dashboard</h4>
        <p>Exemple de rendu des cartes, textes et actions.</p>
      </div>
      <span class="preview-kpi">Colis prêts: 128</span>
      <span class="preview-kpi">Kits prêts: 42</span>
      <span class="preview-kpi">Expéditions: 7</span>
      <div>
        <span class="preview-button">Action principale</span>
        <span class="preview-button secondary">Action secondaire</span>
      </div>
    </div>
  </div>

  <script>
    (function () {
      function resolveColor(rawValue) {
        var value = (rawValue || "").trim();
        return /^#[0-9a-fA-F]{6}$/.test(value) ? value.toLowerCase() : "#ffffff";
      }

      var colorInputs = document.querySelectorAll("[data-color-input='1']");
      colorInputs.forEach(function (input) {
        var swatch = document.querySelector("[data-color-swatch-for='" + input.id + "']");
        var code = document.querySelector("[data-color-value-for='" + input.id + "']");
        var sync = function () {
          var hex = resolveColor(input.value);
          if (swatch) {
            swatch.style.backgroundColor = hex;
          }
          if (code) {
            code.textContent = hex;
          }
        };
        input.addEventListener("input", sync);
        input.addEventListener("change", sync);
        sync();
      });
    })();
  </script>
{% endblock %}
