{% extends "scan/base.html" %}

{% block title %}WMS Scan - Tableau de bord{% endblock %}

{% block content %}
  <div class="scan-card card border-0 ui-comp-card">
    <h2 class="h4 mb-3 ui-comp-title">Tableau de bord</h2>
    <form method="get" class="scan-filters row g-3 scan-dashboard-filter-row">
      <div class="scan-field scan-dashboard-field col-12 col-md-6 col-lg-4">
        <label class="form-label" for="id_period">Période KPI</label>
        <select id="id_period" name="period" class="form-select">
          {% for value, label in period_choices %}
            <option value="{{ value }}"{% if period == value %} selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="scan-field scan-dashboard-field col-12 col-md-6 col-lg-4">
        <label class="form-label" for="id_destination">Destination</label>
        <select id="id_destination" name="destination" class="form-select">
          <option value="">Toutes les destinations</option>
          {% for destination in destinations %}
            <option value="{{ destination.id }}"{% if destination_id == destination.id|stringformat:'s' %} selected{% endif %}>
              {{ destination }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="scan-filter-actions scan-dashboard-filter-actions-inline col-12 col-lg-4 d-flex flex-wrap flex-lg-nowrap gap-2 align-items-end">
        <button type="submit" class="scan-scan-btn btn btn-primary">Appliquer</button>
        <a class="btn btn-outline-secondary" href="{% url 'scan:scan_dashboard' %}">Réinitialiser</a>
      </div>
      <p class="scan-help col-12 mb-0">
        La destination filtre les widgets exp&eacute;dition/suivi. Le stock reste un instantan&eacute; global.
      </p>
    </form>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>KPI p&eacute;riode ({{ period_label }})</h2>
    <div class="scan-kpi-grid">
      {% for card in activity_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Exp&eacute;ditions</h2>
    <div class="scan-kpi-grid">
      {% for card in shipment_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Graphique exp&eacute;ditions ({{ shipments_total }})</h2>
    <div class="scan-chart-bars">
      {% for row in shipment_chart_rows %}
        <div class="scan-chart-row">
          <div class="scan-chart-label">{{ row.label }}</div>
          <div class="scan-chart-track">
            <div class="scan-chart-bar" style="width: {{ row.percent }}%;"></div>
          </div>
          <div class="scan-chart-value">{{ row.count }} / {{ row.percent }}%</div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Colis</h2>
    <div class="scan-kpi-grid">
      {% for card in carton_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Stock</h2>
    <div class="scan-kpi-grid">
      {% for card in stock_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
    {% if low_stock_rows %}
      <div class="scan-table-wrap table-responsive">
        <table class="scan-table table table-sm table-hover">
          <thead>
            <tr>
              <th>Produit</th>
              <th>R&eacute;f</th>
              <th>Disponible</th>
            </tr>
          </thead>
          <tbody>
            {% for row in low_stock_rows %}
              <tr>
                <td>{{ row.name }}</td>
                <td>{{ row.sku }}</td>
                <td class="qty">{{ row.available_qty }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="scan-help">Top 10 des produits sous le seuil global &lt; {{ low_stock_threshold }}.</p>
    {% else %}
      <p class="scan-help">Aucun produit sous le seuil de stock bas (&lt; {{ low_stock_threshold }}).</p>
    {% endif %}
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>R&eacute;ceptions / Commandes</h2>
    <div class="scan-kpi-grid">
      {% for card in flow_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Suivi / Alertes (&gt; {{ tracking_alert_hours }}h)</h2>
    <div class="scan-kpi-grid">
      {% for card in tracking_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Technique / Queue email</h2>
    <div class="scan-kpi-grid">
      {% for card in technical_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2>Blocages workflow (&gt; {{ workflow_blockage_hours }}h)</h2>
    <div class="scan-kpi-grid">
      {% for card in workflow_blockage_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>

  <div class="scan-card card border-0">
    <h2>Suivi SLA</h2>
    <div class="scan-kpi-grid">
      {% for card in sla_cards %}
        <a href="{{ card.url }}" class="scan-kpi-card{% if card.tone != 'neutral' %} is-{{ card.tone }}{% endif %}">
          <span class="scan-kpi-label">{{ card.label }}</span>
          <span class="scan-kpi-value">{{ card.value }}</span>
          <span class="scan-kpi-help">{{ card.help }}</span>
        </a>
      {% endfor %}
    </div>
  </div>
{% endblock %}
