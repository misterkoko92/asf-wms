{% extends "scan/base.html" %}

{% block title %}WMS Scan - {% if is_edit %}Modifier exp&eacute;dition{% else %}Cr&eacute;er exp&eacute;dition{% endif %}{% endblock %}

{% block content %}
  <div class="scan-card">
    <h2>
      {% if is_edit %}
        Modifier l'exp&eacute;dition {{ shipment.reference }}
      {% else %}
        Cr&eacute;er une exp&eacute;dition
      {% endif %}
    </h2>
    {% if form.non_field_errors %}
      <div class="scan-message error">{{ form.non_field_errors }}</div>
    {% endif %}
    <form method="post" novalidate id="shipment-form" data-shipment-edit="{% if is_edit %}1{% else %}0{% endif %}" data-form-bound="{% if form.is_bound %}1{% else %}0{% endif %}">
      {% csrf_token %}

      <div class="scan-field">
        <label for="id_destination">Destination</label>
        <div class="scan-inline">
          {{ form.destination }}
          <a class="scan-scan-btn" href="{% url 'admin:wms_destination_add' %}" target="_blank" rel="noopener">
            Ajouter destination
          </a>
        </div>
        <p class="scan-help">Merci de sélectionner une destination pour poursuivre la création de l'expédition</p>
        {% for error in form.destination.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div id="shipment-shipper-section" class="scan-hidden" hidden>
        <div class="scan-field">
          <label for="id_shipper_contact">Exp&eacute;diteur</label>
          <div class="scan-inline">
            {{ form.shipper_contact }}
            <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
              Ajouter exp&eacute;diteur
            </a>
          </div>
          <p class="scan-help">Merci de sélectionner un expéditeur pour poursuivre la création de l'expédition</p>
          <div id="shipper-empty-message" class="scan-message error scan-hidden" hidden>
            Aucun expéditeur trouvé dans la base, vérifier les &quot;Destinations&quot; des affectés aux Expéditeurs dans les contacts et recommencez
          </div>
          {% for error in form.shipper_contact.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div id="shipment-recipient-section" class="scan-hidden" hidden>
        <div class="scan-field">
          <label for="id_recipient_contact">Destinataire</label>
          <div class="scan-inline">
            {{ form.recipient_contact }}
            <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
              Ajouter destinataire
            </a>
          </div>
          <div id="recipient-empty-message" class="scan-message error scan-hidden" hidden>
            Aucun destinataire trouvé dans la base, vérifier les &quot;Expéditeurs Liés&quot; dans les contacts et recommencez
          </div>
          {% for error in form.recipient_contact.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div id="shipment-correspondent-section" class="scan-hidden" hidden>
        <div class="scan-field">
          <label for="id_correspondent_contact">Correspondant</label>
          <div class="scan-inline">
            {{ form.correspondent_contact }}
            <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
              Ajouter correspondant
            </a>
          </div>
          <p class="scan-help">Merci de sélectionner un destinataire et un correspondant pour poursuivre la création de l'expédition</p>
          <div id="correspondent-empty-message" class="scan-message error scan-hidden" hidden>
            Aucun correspondant trouvé dans la base, vérifier les &quot;Correspondants&quot; dans les contacts et recommencez
          </div>
          {% for error in form.correspondent_contact.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
        </div>
      </div>

      <div id="shipment-details-section" class="scan-hidden" hidden>
        <div class="scan-field">
          <label for="id_carton_count">Nombre de colis</label>
          {{ form.carton_count }}
          {% for error in form.carton_count.errors %}
            <div class="scan-message error">{{ error }}</div>
          {% endfor %}
          <p class="scan-help">
            S&eacute;lectionner ci-dessous des colis d&eacute;j&agrave; pr&eacute;par&eacute;s ou cr&eacute;er des colis mono-produit.
            Pour des colis multi-produits, passer par l'onglet Pr&eacute;paration avant de cr&eacute;er l'exp&eacute;dition.
          </p>
        </div>

        <div class="shipment-lines" id="shipment-lines"></div>

        <div class="scan-field">
          <label for="id_total_weight">Poids total (g)</label>
          <input type="text" id="id_total_weight" readonly>
        </div>

        <div class="scan-field">
          <label>Colis multi-produits</label>
          <a class="scan-scan-btn" href="{% url 'scan:scan_pack' %}">
            Cr&eacute;er des colis multi-produits
          </a>
          <p class="scan-help">
            Utilisez l'onglet Pr&eacute;paration pour cr&eacute;er des colis multi-produits, puis revenez ici pour
            les ajouter à l'expédition.
          </p>
        </div>

        <button type="submit" class="scan-submit">
          {% if is_edit %}Enregistrer modifications{% else %}Cr&eacute;er exp&eacute;dition{% endif %}
        </button>
        {% if is_edit %}
          <p class="scan-help">
            Chaque ligne: sélectionnez un colis préparé ou créez-en un depuis un produit.
            Pour retirer un colis, r&eacute;duisez le nombre de lignes.
          </p>
        {% else %}
          <p class="scan-help">Chaque ligne: sélectionnez un colis préparé ou créez-en un depuis un produit.</p>
        {% endif %}
      </div>
    </form>

    {% if is_edit %}
      <hr class="scan-divider">

      <div class="scan-field">
        <label>Suivi exp&eacute;dition</label>
        <div class="scan-inline">
          {% if shipment.qr_code_image %}
            <img src="{{ shipment.qr_code_image.url }}" alt="QR exp&eacute;dition {{ shipment.reference }}" style="height: 120px; border: 1px solid #ccc;">
          {% else %}
            <span class="scan-help">QR code non disponible.</span>
          {% endif %}
          <a class="scan-scan-btn" href="{% url 'scan:scan_shipment_track' shipment.tracking_token %}">
            Ouvrir suivi
          </a>
        </div>
        {% if tracking_url %}
          <div class="scan-help">
            Lien suivi:
            <a href="{{ tracking_url }}" target="_blank" rel="noopener">{{ tracking_url }}</a>
          </div>
        {% endif %}
      </div>

      <div class="scan-field">
        <label>Documents g&eacute;n&eacute;r&eacute;s</label>
        <div class="scan-docs">
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'shipment_note' %}" target="_blank" rel="noopener">
            Bon d'exp&eacute;dition
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'packing_list_shipment' %}" target="_blank" rel="noopener">
            Liste colisage (lot)
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'donation_certificate' %}" target="_blank" rel="noopener">
            Attestation donation
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_labels' shipment.id %}" target="_blank" rel="noopener">
            &Eacute;tiquettes colis
          </a>
        </div>
      </div>

      <div class="scan-field">
        <label>Liste colisage par carton</label>
        {% if carton_docs %}
          <div class="scan-docs">
            {% for carton in carton_docs %}
              <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_carton_document' shipment.id carton.id %}" target="_blank" rel="noopener">
                {{ carton.code }}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun colis associ&eacute;.</div>
        {% endif %}
      </div>

      <div class="scan-field">
        <label>&Eacute;tiquettes par carton</label>
        {% if carton_docs %}
          <div class="scan-docs">
            {% for carton in carton_docs %}
              <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_label' shipment.id carton.id %}" target="_blank" rel="noopener">
                {{ carton.code }}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun colis associ&eacute;.</div>
        {% endif %}
      </div>

      <div class="scan-field">
        <label>Ajouter un document</label>
        <form method="post" enctype="multipart/form-data" action="{% url 'scan:scan_shipment_document_upload' shipment.id %}">
          {% csrf_token %}
          <div class="scan-inline">
            <input type="file" name="document_file" required>
            <button type="submit" class="scan-scan-btn">Uploader</button>
          </div>
          <div class="scan-help">Formats autorises: PDF, JPG, PNG, XLSX, DOCX.</div>
        </form>
      </div>

      <div class="scan-field">
        <label>Documents additionnels</label>
        {% if documents %}
          <div class="scan-docs">
            {% for document in documents %}
              <div class="scan-inline">
                <a class="scan-scan-btn scan-doc-btn" href="{{ document.file.url }}" target="_blank" rel="noopener">
                  {{ document.file.name|default:"Document" }}
                </a>
                <form method="post" action="{% url 'scan:scan_shipment_document_delete' shipment.id document.id %}">
                  {% csrf_token %}
                  <button type="submit" class="scan-scan-btn scan-doc-btn">Supprimer</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun document additionnel.</div>
        {% endif %}
      </div>
    {% endif %}
    {{ products_json|json_script:"product-data" }}
    {{ cartons_json|json_script:"carton-data" }}
    {{ line_values|json_script:"shipment-lines-data" }}
    {{ line_errors|json_script:"shipment-lines-errors" }}
    {{ destinations_json|json_script:"destination-data" }}
    {{ shipper_contacts_json|json_script:"shipper-contacts-data" }}
    {{ recipient_contacts_json|json_script:"recipient-contacts-data" }}
    {{ correspondent_contacts_json|json_script:"correspondent-contacts-data" }}
    <datalist id="product-options">
      {% for product in products_json %}
        <option value="{{ product.name }}" label="{{ product.sku }}{% if product.barcode %} | {{ product.barcode }}{% endif %}{% if product.ean %} | {{ product.ean }}{% endif %}"></option>
      {% endfor %}
    </datalist>
  </div>
{% endblock %}
