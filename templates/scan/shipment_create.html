{% extends "scan/base.html" %}

{% block title %}WMS Scan - {% if is_edit %}Modifier expedition{% else %}Creer expedition{% endif %}{% endblock %}

{% block content %}
  <div class="scan-card">
    <h2>
      {% if is_edit %}
        Modifier l'expedition {{ shipment.reference }}
      {% else %}
        Creer une expedition
      {% endif %}
    </h2>
    {% if form.non_field_errors %}
      <div class="scan-message error">{{ form.non_field_errors }}</div>
    {% endif %}
    <form method="post" novalidate id="shipment-form">
      {% csrf_token %}

      <div class="scan-field">
        <label for="id_destination">Destination</label>
        <div class="scan-inline">
          {{ form.destination }}
          <a class="scan-scan-btn" href="{% url 'admin:wms_destination_add' %}" target="_blank" rel="noopener">
            Ajouter destination
          </a>
        </div>
        {% for error in form.destination.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label for="id_shipper_contact">Expediteur</label>
        <div class="scan-inline">
          {{ form.shipper_contact }}
          <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
            Ajouter expediteur
          </a>
        </div>
        {% for error in form.shipper_contact.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label for="id_recipient_contact">Destinataire</label>
        <div class="scan-inline">
          {{ form.recipient_contact }}
          <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
            Ajouter destinataire
          </a>
        </div>
        {% for error in form.recipient_contact.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label for="id_correspondent_contact">Correspondant</label>
        <div class="scan-inline">
          {{ form.correspondent_contact }}
          <a class="scan-scan-btn" href="{% url 'admin:contacts_contact_add' %}" target="_blank" rel="noopener">
            Ajouter correspondant
          </a>
        </div>
        {% for error in form.correspondent_contact.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="scan-field">
        <label for="id_carton_count">Nombre de colis</label>
        {{ form.carton_count }}
        {% for error in form.carton_count.errors %}
          <div class="scan-message error">{{ error }}</div>
        {% endfor %}
      </div>

      <div class="shipment-lines" id="shipment-lines"></div>

      <div class="scan-field">
        <label for="id_total_weight">Poids total (g)</label>
        <input type="text" id="id_total_weight" readonly>
      </div>

      <button type="submit" class="scan-submit">
        {% if is_edit %}Enregistrer modifications{% else %}Creer expedition{% endif %}
      </button>
      {% if is_edit %}
        <p class="scan-help">
          Chaque ligne: selectionnez un colis prepare ou creez-en un depuis un produit.
          Pour retirer un colis, reduisez le nombre de lignes.
        </p>
      {% else %}
        <p class="scan-help">Chaque ligne: selectionnez un colis prepare ou creez-en un depuis un produit.</p>
      {% endif %}
    </form>

    {% if is_edit %}
      <hr class="scan-divider">

      <div class="scan-field">
        <label>Documents generes</label>
        <div class="scan-docs">
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'shipment_note' %}" target="_blank" rel="noopener">
            Bon d'expedition
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'packing_list_shipment' %}" target="_blank" rel="noopener">
            Liste colisage (lot)
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_document' shipment.id 'donation_certificate' %}" target="_blank" rel="noopener">
            Attestation donation
          </a>
          <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_labels' shipment.id %}" target="_blank" rel="noopener">
            Etiquettes colis
          </a>
        </div>
      </div>

      <div class="scan-field">
        <label>Liste colisage par carton</label>
        {% if carton_docs %}
          <div class="scan-docs">
            {% for carton in carton_docs %}
              <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_carton_document' shipment.id carton.id %}" target="_blank" rel="noopener">
                {{ carton.code }}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun colis associe.</div>
        {% endif %}
      </div>

      <div class="scan-field">
        <label>Etiquettes par carton</label>
        {% if carton_docs %}
          <div class="scan-docs">
            {% for carton in carton_docs %}
              <a class="scan-scan-btn scan-doc-btn" href="{% url 'scan:scan_shipment_label' shipment.id carton.id %}" target="_blank" rel="noopener">
                {{ carton.code }}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun colis associe.</div>
        {% endif %}
      </div>

      <div class="scan-field">
        <label>Ajouter un document</label>
        <form method="post" enctype="multipart/form-data" action="{% url 'scan:scan_shipment_document_upload' shipment.id %}">
          {% csrf_token %}
          <div class="scan-inline">
            <input type="file" name="document_file" required>
            <button type="submit" class="scan-scan-btn">Uploader</button>
          </div>
          <div class="scan-help">Formats autorises: PDF, JPG, PNG, XLSX, DOCX.</div>
        </form>
      </div>

      <div class="scan-field">
        <label>Documents additionnels</label>
        {% if documents %}
          <div class="scan-docs">
            {% for document in documents %}
              <div class="scan-inline">
                <a class="scan-scan-btn scan-doc-btn" href="{{ document.file.url }}" target="_blank" rel="noopener">
                  {{ document.file.name|default:"Document" }}
                </a>
                <form method="post" action="{% url 'scan:scan_shipment_document_delete' shipment.id document.id %}">
                  {% csrf_token %}
                  <button type="submit" class="scan-scan-btn scan-doc-btn">Supprimer</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="scan-help">Aucun document additionnel.</div>
        {% endif %}
      </div>
    {% endif %}
    {{ products_json|json_script:"product-data" }}
    {{ cartons_json|json_script:"carton-data" }}
    {{ line_values|json_script:"shipment-lines-data" }}
    {{ line_errors|json_script:"shipment-lines-errors" }}
    {{ destinations_json|json_script:"destination-data" }}
    {{ recipient_contacts_json|json_script:"recipient-contacts-data" }}
    {{ correspondent_contacts_json|json_script:"correspondent-contacts-data" }}
    <datalist id="product-options">
      {% for product in products_json %}
        <option value="{{ product.name }}" label="{{ product.sku }}{% if product.barcode %} | {{ product.barcode }}{% endif %}"></option>
      {% endfor %}
    </datalist>
  </div>
{% endblock %}
