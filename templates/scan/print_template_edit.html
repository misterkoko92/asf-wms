{% extends "scan/base.html" %}
{% load static %}

{% block title %}Template {{ doc_label }}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'scan/print_template_editor.css' %}">
{% endblock %}

{% block content %}

  <div class="scan-card template-card">
    <div class="template-header">
      <div>
        <h2>Template: {{ doc_label }}</h2>
        <div class="template-meta">Type: <code>{{ doc_type }}</code></div>
      </div>
      <div class="template-status">
        <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'scan:scan_print_templates' %}">Retour</a>
        {% if template and template.layout %}
          <span class="template-badge template-badge-custom">Personnalisé</span>
        {% else %}
          <span class="template-badge">Par d&eacute;faut</span>
        {% endif %}
      </div>
    </div>
    <p class="template-help">
      Glisser-déposer les blocs pour réorganiser. Éditez le contenu et les styles à gauche,
      puis enregistrez. Les changements s'appliquent aux impressions.
    </p>
  </div>

  <div id="template-editor" class="template-editor" data-preview-url="{% url 'scan:scan_print_template_preview' %}">
    <aside class="template-panel">
      <div class="template-panel-section">
        <h3>Bibliothèque de blocs</h3>
        <div class="template-block-library" id="block-library"></div>
      </div>

      <div class="template-panel-section">
        <h3>Blocs du document</h3>
        <ul class="template-block-list" id="block-list"></ul>
      </div>

      <div class="template-panel-section">
        <h3>Propriétés</h3>
        <div id="block-editor" class="template-block-editor">
          <p class="template-muted">S&eacute;lectionnez un bloc pour le modifier.</p>
        </div>
      </div>

      <div class="template-panel-section">
        <h3>Versions</h3>
        <div class="template-versions">
          {% if versions %}
            {% for version in versions %}
              <form method="post" class="template-version-row">
                {% csrf_token %}
                <input type="hidden" name="action" value="restore">
                <input type="hidden" name="version_id" value="{{ version.id }}">
                <div>
                  <strong>v{{ version.version }}</strong>
                  <div class="template-version-meta">
                    {{ version.created_at|date:"d/m/Y H:i" }}
                    {% if version.created_by %} - {{ version.created_by.get_full_name|default:version.created_by.username }}{% endif %}
                  </div>
                </div>
                <button type="submit" class="scan-scan-btn btn btn-outline-primary">Restaurer</button>
              </form>
            {% endfor %}
          {% else %}
            <div class="template-muted">Aucune version sauvegardée.</div>
          {% endif %}
        </div>
      </div>
    </aside>

    <main class="template-preview">
      <form id="template-form" method="post" class="template-toolbar">
        {% csrf_token %}
        <input type="hidden" name="layout_json" id="layout-json">
        <input type="hidden" name="action" id="layout-action" value="save">

        <button type="submit" class="scan-submit scan-submit-inline">Enregistrer</button>
        <button type="button" class="scan-submit scan-submit-inline secondary" id="reset-layout">
          Revenir par d&eacute;faut
        </button>
        <button type="button" class="scan-submit scan-submit-inline" id="preview-layout">
          Actualiser aperçu
        </button>

        {% if doc_type == "product_label" or doc_type == "product_qr" %}
          <label class="template-preview-label" for="preview-product">Aperçu avec produit</label>
          <select id="preview-product" class="template-preview-select">
            <option value="">Exemple</option>
            {% for product in products %}
              <option value="{{ product.id }}">{{ product.label }}</option>
            {% endfor %}
          </select>
        {% else %}
          <label class="template-preview-label" for="preview-shipment">Aperçu avec exp.</label>
          <select id="preview-shipment" class="template-preview-select">
            <option value="">Exemple</option>
            {% for shipment in shipments %}
              <option value="{{ shipment.id }}">{{ shipment.label }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </form>

      <div class="template-preview-frame">
        <iframe id="template-preview" title="Aperçu document"></iframe>
      </div>
      <div id="preview-status" class="template-muted"></div>
    </main>
  </div>

  {{ layout|json_script:"layout-data" }}
  {{ block_library|json_script:"block-library-data" }}
  {{ doc_type|json_script:"doc-type-data" }}

  <script src="{% static 'scan/print_template_editor.js' %}"></script>
{% endblock %}
