{% extends "scan/base.html" %}

{% block title %}WMS Scan - FAQ & Documentation{% endblock %}

{% block content %}
  <div class="scan-card">
    <h2>Vue d'ensemble</h2>
    <p>
      Cette page d&eacute;crit le fonctionnement complet du WMS Scan, du stock &agrave;
      l'exp&eacute;dition. Les flux sont con&ccedil;us pour &ecirc;tre rapides sur mobile et
      pour rester coh&eacute;rents en base.
    </p>
    <ul>
      <li><strong>Produit</strong> : fiche article (SKU, nom, marque, poids, emplacement).</li>
      <li><strong>Lot</strong> : stock r&eacute;el par produit (quantit&eacute;, p&eacute;remption, lot, emplacement).</li>
      <li><strong>Carton</strong> : unit&eacute; de pr&eacute;paration (DRAFT, PICKING, PACKED, ASSIGNED, LABELED, SHIPPED).</li>
      <li><strong>Exp&eacute;dition</strong> : regroupe des cartons pour une destination.</li>
      <li><strong>Suivi exp&eacute;dition</strong> : journal des scans (QR) avec horodatage.</li>
    </ul>
    <h3>Statuts cle</h3>
    <ul>
      <li><strong>Carton</strong> : Cr&eacute;&eacute; (draft), En pr&eacute;paration (picking), Pr&ecirc;t (packed), Affect&eacute; (assigned), &Eacute;tiquet&eacute; (labeled), Exp&eacute;di&eacute; (shipped).</li>
      <li><strong>Exp&eacute;dition</strong> : Cr&eacute;ation (draft), En cours (picking), Pr&ecirc;t (packed), Planifi&eacute; (planned), Exp&eacute;di&eacute; (shipped), Re&ccedil;u escale (received_correspondent), Livr&eacute; (delivered).</li>
      <li><strong>Litige</strong> : drapeau transverse sur exp&eacute;dition (<code>is_disputed</code>), activable &agrave; tout moment du suivi.</li>
      <li><strong>R&eacute;ception</strong> : DRAFT tant que les lignes ne sont pas r&eacute;ceptionn&eacute;es.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Acc&egrave;s &amp; r&ocirc;les</h2>
    <ul>
      <li>Les pages /scan internes sont prot&eacute;g&eacute;es par login staff.</li>
      <li>Le menu <strong>Compte</strong> affiche email/username, lien Admin (si staff), changer de compte, d&eacute;connexion.</li>
      <li><strong>Imports</strong> et <strong>Templates</strong> sont r&eacute;serv&eacute;s aux superusers.</li>
      <li>Exception: le suivi exp&eacute;dition par token (<code>/scan/shipment/track/&lt;token&gt;/</code>) est public et ne demande pas de login.</li>
      <li>Le suivi legacy par r&eacute;f&eacute;rence est staff-only et en consultation seule (d&eacute;sactivable via <code>ENABLE_SHIPMENT_TRACK_LEGACY=false</code>).</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Donn&eacute;es de r&eacute;f&eacute;rence</h2>
    <p>Avant utilisation, vérifier ces données dans l'admin :</p>
    <ul>
      <li><strong>Contacts</strong> avec tags : exp&eacute;diteur, destinataire, correspondant, donateur, transporteur.</li>
      <li>Pour les exp&eacute;diteurs/correspondants: renseigner <strong>Destinations</strong> (vide = global).</li>
      <li>Pour les destinataires: renseigner <strong>Exp&eacute;diteurs li&eacute;s</strong> (vide = tous les exp&eacute;diteurs).</li>
      <li><strong>Destinations</strong> : ville, code IATA, pays, correspondant li&eacute;.</li>
      <li><strong>Formats de carton</strong> : un format par d&eacute;faut pour la pr&eacute;paration.</li>
      <li><strong>Entrep&ocirc;ts</strong> et <strong>Emplacements</strong> : entrep&ocirc;t / rack / &eacute;tag&egrave;re / bac.</li>
      <li><strong>Couleurs rack</strong> : associées à un rack (entrepôt + zone).</li>
      <li><strong>Cat&eacute;gories</strong> : hi&eacute;rarchie L1 -> L4 (cr&eacute;&eacute;es &agrave; l'import si besoin).</li>
    </ul>
    <p>
      Quand un s&eacute;lecteur n'a qu'un seul choix, il est auto-s&eacute;lectionn&eacute;.
    </p>
  </div>

  <div class="scan-card">
    <h2>Vue stock</h2>
    <ul>
      <li>Recherche multi-cl&eacute;s : nom, SKU, barcode, EAN.</li>
      <li>Filtres : catégorie, entrepôt. Tri : catégorie, nom, référence, stock.</li>
      <li>Le stock affiche correspond aux lots disponibles.</li>
      <li>La colonne <strong>Derni&egrave;re modification</strong> suit les mouvements de stock.</li>
      <li>Dans les pages <strong>Vue...</strong>, chaque en-t&ecirc;te de colonne est triable et filtrable.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>MAJ stock</h2>
    <ul>
      <li>S&eacute;lection produit par nom, SKU, barcode ou EAN (scan cam&eacute;ra possible).</li>
      <li>Si inconnu, le bouton propose de cr&eacute;er le produit dans l'admin.</li>
      <li>Quantit&eacute;, p&eacute;remption et lot sont enregistr&eacute;s dans un nouveau lot.</li>
      <li>Le lot est plac&eacute; sur l'emplacement par d&eacute;faut du produit.</li>
      <li>Les champs Marque / Emplacement / Entrep&ocirc;t s'affichent en lecture seule.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Supprimer produit</h2>
    <ul>
      <li>Retire du stock pour casse, perte ou correction.</li>
      <li>Référence expédition optionnelle pour tracer un flux.</li>
      <li>Motif + notes permettent de justifier la sortie.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Pr&eacute;paration (cartons)</h2>
    <ul>
      <li>Choisir un format de carton (ou personnaliser les dimensions).</li>
      <li>Ajouter une ou plusieurs lignes produit + quantit&eacute; (scan possible).</li>
      <li>Le syst&egrave;me peut cr&eacute;er plusieurs cartons selon la capacit&eacute; (poids/volume).</li>
      <li>Optionnel : r&eacute;f&eacute;rence exp&eacute;dition pour affecter directement les cartons.</li>
      <li>Optionnel : emplacement courant pour tracer le stockage temporaire.</li>
    </ul>
    <p>
      Un carton assigné à une expédition affiche le statut <strong>Affecté</strong>
      dans la Vue Colis.
    </p>
    <p>
      Le code carton suit le format <strong>TYPE-AAAAMMJJ-N</strong> (type dominant par poids).
      Le volume est calcul&eacute; avec les dimensions du carton (format par d&eacute;faut si non renseign&eacute;).
    </p>
  </div>

  <div class="scan-card">
    <h2>Cr&eacute;er une exp&eacute;dition</h2>
    <ul>
      <li>S&eacute;quencement: destination d'abord, puis exp&eacute;diteur, puis destinataire + correspondant, puis le reste du formulaire.</li>
      <li>Exp&eacute;diteur: tag <strong>Exp&eacute;diteur</strong> + destination explicite ou globale (destinations vides).</li>
      <li>Destinataire: tag <strong>Destinataire</strong> + exp&eacute;diteur li&eacute; explicite ou global (exp&eacute;diteurs li&eacute;s vides).</li>
      <li>Correspondant: tag <strong>Correspondant</strong> + destination; si la destination a un correspondant li&eacute;, ce choix est impos&eacute;.</li>
      <li>Si aucun correspondant n'est li&eacute; &agrave; la destination, le s&eacute;lecteur correspondant reste vide.</li>
      <li>Ajouter des cartons <strong>Pr&ecirc;t</strong> non affect&eacute;s, ou cr&eacute;er des cartons depuis des produits.</li>
      <li>&Agrave; l'affectation &agrave; l'exp&eacute;dition, un carton passe en statut <strong>Affect&eacute;</strong>.</li>
      <li><strong>Enregistrer en brouillon</strong> cr&eacute;e une exp&eacute;dition temporaire <strong>EXP-TEMP-XX</strong> modifiable plus tard.</li>
      <li><strong>Cr&eacute;er des colis multi-produits</strong> (depuis la cr&eacute;ation) enregistre d'abord un brouillon puis ouvre l'onglet Pr&eacute;paration.</li>
      <li>Le poids total est calcul&eacute; automatiquement.</li>
      <li>En modification: QR, documents, &eacute;tiquettes et uploads additionnels.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Vue Colis</h2>
    <ul>
      <li>Liste tous les cartons pr&eacute;par&eacute;s avec leur statut et contenu.</li>
      <li>Actions explicites: <strong>Marquer &eacute;tiquet&eacute;</strong> et <strong>Retirer &eacute;tiquette</strong> pour les cartons affect&eacute;s.</li>
      <li>Un carton affect&eacute;/etiquet&eacute; d&eacute;saffect&eacute; d'une exp&eacute;dition revient en <strong>Pr&ecirc;t</strong>.</li>
      <li>Un carton <strong>Exp&eacute;di&eacute;</strong> n'est plus modifiable.</li>
      <li>Poids et remplissage sont affich&eacute;s quand les dimensions sont disponibles.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Vue Exp&eacute;ditions</h2>
    <ul>
      <li><strong>Brouillon</strong> : exp&eacute;dition temporaire (r&eacute;f&eacute;rence <strong>EXP-TEMP-XX</strong>) sauvegard&eacute;e pour reprise ult&eacute;rieure.</li>
      <li><strong>Cr&eacute;ation</strong> : exp&eacute;dition active sans colis &eacute;tiquet&eacute; (r&eacute;f&eacute;rence finale).</li>
      <li><strong>En cours</strong> : tant que tous les colis ne sont pas &eacute;tiquet&eacute;s.</li>
      <li><strong>Pr&ecirc;t</strong> : tous les colis sont &eacute;tiquet&eacute;s.</li>
      <li><strong>Planifi&eacute;</strong> : verrouille la modification des colis de l'exp&eacute;dition.</li>
      <li><strong>Exp&eacute;di&eacute;</strong>, <strong>Re&ccedil;u escale</strong>, <strong>Livr&eacute;</strong> : progression via le suivi.</li>
      <li><strong>Litige</strong> : pr&eacute;fixe visuel sur le statut (ex: "Litige - Planifi&eacute;").</li>
    </ul>
    <p>
      La date <strong>mise en disponible</strong> est renseign&eacute;e au passage en <strong>Pr&ecirc;t</strong>,
      puis effac&eacute;e si l'exp&eacute;dition repasse en <strong>En cours</strong>.
    </p>
    <p>
      Le bouton <strong>Suivi</strong> ouvre la page publique de suivi via QR.
    </p>
    <p>
      Les brouillons temporaires anciens peuvent &ecirc;tre archiv&eacute;s via l'action <strong>Archiver brouillons anciens</strong>.
    </p>
  </div>

  <div class="scan-card">
    <h2>Suivi des exp&eacute;ditions (Gestion)</h2>
    <ul>
      <li>Cette vue affiche les exp&eacute;ditions en statut <strong>Planifi&eacute;</strong>, <strong>Exp&eacute;di&eacute;</strong>, <strong>Re&ccedil;u escale</strong> et <strong>Livr&eacute;</strong>.</li>
      <li>Filtres: semaine planifi&eacute;e et dossiers clos (exclure/inclure).</li>
      <li>Colonnes dates: Planifi&eacute;, OK mise &agrave; bord, Exp&eacute;di&eacute;, Re&ccedil;u escale, Livr&eacute;.</li>
      <li>Bouton <strong>Suivi/MAJ</strong>: ouvre la page de suivi de l'exp&eacute;dition.</li>
      <li>Bouton <strong>Clore le dossier</strong>: actif seulement quand toutes les &eacute;tapes requises sont valid&eacute;es et qu'il n'y a pas de litige.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Documents & &eacute;tiquettes</h2>
    <ul>
      <li>Bon d'exp&eacute;dition, listes de colisage et attestation sont g&eacute;n&eacute;r&eacute;s par exp&eacute;dition.</li>
      <li>&Eacute;tiquettes colis g&eacute;n&eacute;r&eacute;es par carton (impression en masse possible).</li>
      <li>Le QR code exp&eacute;dition apparait sur l'&eacute;tiquette et ouvre le suivi public.</li>
      <li>Documents additionnels uploadables (PDF, JPG, PNG, XLSX, DOCX).</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Vue Commande (associations)</h2>
    <ul>
      <li>Liste des demandes associations avec statut de revue.</li>
      <li>Changer le statut et informer le contact (refus / à modifier).</li>
      <li>Si approuv&eacute;, cr&eacute;ation d'exp&eacute;dition en un clic.</li>
      <li>Les documents sont disponibles une fois approuv&eacute;.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>R&eacute;ception palette</h2>
    <ul>
      <li>Enregistre une r&eacute;ception avec donateur + transporteur.</li>
      <li>Le stock n'est pas modifi&eacute; ici : c'est un suivi logistique.</li>
      <li>La r&eacute;f&eacute;rence est g&eacute;n&eacute;r&eacute;e automatiquement.</li>
      <li>La date demande transport est optionnelle.</li>
    </ul>
    <h3>Upload listing</h3>
    <ul>
      <li>Formats accept&eacute;s: CSV / XLS / XLSX / PDF texte (pas d'OCR image).</li>
      <li>Conseil: privil&eacute;gier .xlsx pour la gestion des accents.</li>
      <li>CSV: encodage UTF-8 (BOM) + s&eacute;parateur ';'.</li>
      <li>D&eacute;tection auto du type, ou s&eacute;lection manuelle PDF/Excel/CSV.</li>
      <li>PDF: choix des pages (toutes ou d&eacute;but/fin). D&eacute;but vide = page 1, fin vide = derni&egrave;re page.</li>
      <li>Excel: choix de la feuille + ligne des titres.</li>
      <li>Mapping des colonnes avec champs requis: <strong>nom + quantit&eacute;</strong>.</li>
      <li>R&eacute;cap: choix du match produit, &eacute;dition des champs, validation ligne par ligne.</li>
      <li>Match auto sur <strong>Nom + Marque</strong> (liste modifiable).</li>
      <li>Si produit existant: champs produit en lecture seule, seules quantit&eacute; / emplacement changent.</li>
      <li>Override possible via SKU / barcode / nom.</li>
    </ul>
    <p class="scan-help">
      À la validation, une réception palette est créée puis les lignes sont réceptionnées.
      Emplacement requis (via listing ou emplacement par d&eacute;faut du produit).
    </p>
  </div>

  <div class="scan-card">
    <h2>R&eacute;ception association</h2>
    <ul>
      <li>Enregistre cartons + hors format pour une association.</li>
      <li>Les hors format exigent une description pour chaque ligne.</li>
      <li>La r&eacute;f&eacute;rence est g&eacute;n&eacute;r&eacute;e automatiquement.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>R&eacute;ception standard (don/palette)</h2>
    <ul>
      <li>Cr&eacute;er une r&eacute;ception puis ajouter des lignes produits.</li>
      <li><strong>R&eacute;ceptionner maintenant</strong> cr&eacute;&eacute; le lot stock imm&eacute;diatement.</li>
      <li>Si emplacement vide, on utilise l'emplacement par d&eacute;faut du produit.</li>
      <li>Un bouton permet de r&eacute;ceptionner toutes les lignes en attente.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Vue r&eacute;ception</h2>
    <ul>
      <li>Filtre rapide : Palette, Association ou Tout.</li>
      <li>Colonnes : date, nom, quantit&eacute; palettes/colis, hors format, transporteur.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Imports (admin)</h2>
    <ul>
      <li>Ajout unitaire ou import CSV/XLS/XLSX par bloc.</li>
      <li>CSV: encodage UTF-8 (BOM) + s&eacute;parateur ';'.</li>
      <li>Templates disponibles + export complet de chaque table.</li>
      <li>Produit: match par SKU sinon Nom+Marque, confirmation avant update.</li>
      <li>Si SKU d&eacute;j&agrave; utilise et cr&eacute;ation forc&eacute;e: SKU auto-g&eacute;n&eacute;r&eacute;.</li>
      <li>Quantit&eacute; initiale applique un mouvement de stock (emplacement requis).</li>
      <li>Emplacements: entrep&ocirc;t/rack/&eacute;tag&egrave;re/bac requis, rack color optionnel.</li>
      <li>Cat&eacute;gories: chemin possible (L1 > L2 > L3).</li>
      <li>Contacts: tags fusionn&eacute;s (ajout), destination cr&eacute;&eacute;e si absente.</li>
      <li>Utilisateurs: mot de passe obligatoire si IMPORT_DEFAULT_PASSWORD est vide.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Templates (admin)</h2>
    <ul>
      <li>Personnaliser visuellement les documents.</li>
      <li>Utiliser l'aper&ccedil;u pour v&eacute;rifier le rendu.</li>
      <li>Apr&egrave;s modification, recharger la page si besoin.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>Suivi exp&eacute;dition (QR)</h2>
    <ul>
      <li>Un QR code est généré à la création de l'expédition.</li>
      <li>Le scan ouvre une page publique avec documents + historique.</li>
      <li>Champs obligatoires : <strong>Nom</strong> et <strong>Structure</strong>.</li>
      <li>Commentaires optionnels et horodatage automatique (AAAA/MM/JJ HHhMM).</li>
      <li>Le s&eacute;lecteur propose automatiquement l'&eacute;tape suivante.</li>
      <li>&Eacute;tapes : OK pour planification, Planifi&eacute;, D&eacute;plac&eacute; au magasin export, OK mise &agrave; bord, Re&ccedil;u correspondant, Re&ccedil;u destinataire.</li>
      <li>Passage de statut exp&eacute;dition : Planifi&eacute;/D&eacute;plac&eacute; =&gt; Planifi&eacute;, Mise &agrave; bord =&gt; Exp&eacute;di&eacute;, Re&ccedil;u correspondant =&gt; Re&ccedil;u escale, Re&ccedil;u destinataire =&gt; Livr&eacute;.</li>
      <li>Depuis la page de suivi staff, le bouton <strong>Revenir &agrave; la liste</strong> revient vers la derni&egrave;re vue (Vue Exp&eacute;ditions ou Suivi des exp&eacute;ditions).</li>
      <li>Si des champs de suivi sont modifi&eacute;s non enregistr&eacute;s, une confirmation propose <strong>OUI</strong> (enregistrer) ou <strong>NON</strong> (quitter sans enregistrer).</li>
      <li>Depuis le suivi, vous pouvez <strong>D&eacute;clarer litige</strong> puis <strong>R&eacute;soudre litige et remettre Pr&ecirc;t</strong>.</li>
    </ul>
    <p>
      Pour que le QR fonctionne depuis un téléphone, définir <strong>SITE_BASE_URL</strong>
      sur l'environnement de déploiement.
    </p>
  </div>

  <div class="scan-card">
    <h2>Scanner & synchronisation</h2>
    <ul>
      <li>Le bouton <strong>Scan</strong> ouvre la cam&eacute;ra et remplit le champ cible.</li>
      <li>Si la cam&eacute;ra est bloqu&eacute;e, autoriser l'acc&egrave;s dans le navigateur.</li>
      <li>Si le scan n'est pas support&eacute;, saisir le code manuellement.</li>
      <li>Le QR exp&eacute;dition ouvre uniquement la page de suivi + documents (sans login).</li>
      <li>La bannière de synchro indique qu'une mise à jour est disponible.</li>
    </ul>
  </div>

  <div class="scan-card">
    <h2>FAQ rapide</h2>
    <ul>
      <li><strong>Mes listes sont vides</strong> : v&eacute;rifier les tags + destinations (exp&eacute;diteurs/correspondants) et les exp&eacute;diteurs li&eacute;s (destinataires).</li>
      <li><strong>Stock à zéro</strong> : vérifier les lots disponibles et leur emplacement.</li>
      <li><strong>Cam&eacute;ra ne s'ouvre pas</strong> : autoriser la cam&eacute;ra, tester un autre navigateur.</li>
      <li><strong>Un carton est bloqu&eacute;</strong> : un carton exp&eacute;di&eacute; est non modifiable, et une exp&eacute;dition planifi&eacute;e/verrouill&eacute;e bloque les changements colis.</li>
      <li><strong>Correspondant introuvable</strong> : v&eacute;rifier le correspondant li&eacute; sur la destination s&eacute;lectionn&eacute;e.</li>
      <li><strong>Le QR n'ouvre rien</strong> : v&eacute;rifier SITE_BASE_URL et relancer l'app.</li>
    </ul>
  </div>
{% endblock %}
