{% load static %}
<!doctype html>
<html lang="fr" data-theme="classic" data-ui="classic">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0f5f4f">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="manifest" href="{% static 'scan/manifest.json' %}">
  <script>
    (function() {
      try {
        var storedUi = localStorage.getItem('wms-ui');
        if (storedUi) {
          document.documentElement.setAttribute('data-ui', storedUi);
        }
      } catch (err) {
        // Ignore storage errors.
      }
    })();
  </script>
  <link rel="stylesheet" href="{% static 'scan/scan.css' %}">
  {% block extra_head %}{% endblock %}
  <title>{% block title %}WMS Scan{% endblock %}</title>
</head>
<body>
  <div class="scan-shell{% if shell_class %} {{ shell_class }}{% endif %}">
    <header class="scan-header">
      <div>
        <h1 class="scan-title">ASF WMS Scan</h1>
        <p class="scan-subtitle">Flux rapides pour mobile et scanner.</p>
      </div>
      <div class="scan-header-actions">
        <div class="scan-ui-toggle">
          <span class="scan-theme-label">Interface</span>
          <button type="button" id="ui-toggle" class="scan-ui-button" aria-pressed="false">
            Classique
          </button>
        </div>
        <div class="scan-theme-toggle">
          <span class="scan-theme-label">Theme</span>
          <button type="button" id="theme-toggle" class="scan-theme-button" aria-pressed="false">
            Classique
          </button>
        </div>
        <details class="scan-account">
          <summary class="scan-account-toggle">
            <span class="scan-account-label">Compte</span>
            <span class="scan-account-value" title="{{ request.user.email|default:request.user.username }}">
              {% if request.user.email %}{{ request.user.email }}{% else %}{{ request.user.username }}{% endif %}
            </span>
          </summary>
          <div class="scan-account-menu">
            <div class="scan-account-meta">
              <span>Email: {{ request.user.email|default:"-" }}</span>
              <span>Username: {{ request.user.username }}</span>
            </div>
            {% if request.user.is_staff %}
              <a class="scan-account-link" href="/admin/">Admin</a>
            {% endif %}
            <a class="scan-account-link" href="/admin/logout/?next=/admin/login/?next=/scan/">Changer de compte</a>
            <a class="scan-account-link" href="/admin/logout/?next=/">Deconnexion</a>
          </div>
        </details>
      </div>
    </header>

    <div class="scan-body">
      <nav class="scan-nav">
        <a href="{% url 'scan:scan_stock' %}" class="{% if active == 'stock' %}active{% endif %}">Vue stock</a>
        <a href="{% url 'scan:scan_cartons_ready' %}" class="{% if active == 'cartons_ready' %}active{% endif %}">Vue Colis</a>
        <a href="{% url 'scan:scan_shipments_ready' %}" class="{% if active == 'shipments_ready' %}active{% endif %}">Vue Expeditions</a>
        <a href="{% url 'scan:scan_orders_view' %}" class="{% if active == 'orders_view' %}active{% endif %}">Vue Commande</a>
        <a href="{% url 'scan:scan_receipts_view' %}" class="{% if active == 'receipts_view' %}active{% endif %}">Vue reception</a>
        <a href="{% url 'scan:scan_receive_pallet' %}" class="{% if active == 'receive_pallet' %}active{% endif %}">Reception palette</a>
        <a href="{% url 'scan:scan_receive_association' %}" class="{% if active == 'receive_association' %}active{% endif %}">Reception association</a>
        <a href="{% url 'scan:scan_stock_update' %}" class="{% if active == 'stock_update' %}active{% endif %}">MAJ stock</a>
        <a href="{% url 'scan:scan_pack' %}" class="{% if active == 'pack' %}active{% endif %}">Preparation</a>
        <a href="{% url 'scan:scan_shipment_create' %}" class="{% if active == 'shipment' %}active{% endif %}">Creer expedition</a>
        <a href="{% url 'scan:scan_out' %}" class="{% if active == 'out' %}active{% endif %}">Supprimer produit</a>
        <a href="{% url 'scan:scan_faq' %}" class="{% if active == 'faq' %}active{% endif %}">FAQ / Docs</a>
        {% if request.user.is_superuser %}
          <a href="{% url 'scan:scan_print_templates' %}" class="{% if active == 'print_templates' %}active{% endif %}">Templates</a>
          <a href="{% url 'scan:scan_import' %}" class="{% if active == 'imports' %}active{% endif %}">Imports</a>
        {% endif %}
      </nav>

      <main class="scan-main">
        {% if messages %}
          <div class="scan-messages">
            {% for message in messages %}
              <div class="scan-message {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
        {% if admin_pending_account_requests %}
          <div class="scan-message warning">
            Nouvelles demandes de compte en attente: {{ admin_pending_account_requests }}
            (<a href="{% url 'admin:wms_publicaccountrequest_changelist' %}">voir</a>)
          </div>
        {% endif %}
        <div id="scan-sync-banner" class="scan-sync-banner" data-sync-url="{% url 'scan:scan_sync' %}" data-sync-interval="8000">
          <span>Des changements sont disponibles. Recharge pour synchroniser.</span>
          <button type="button" id="scan-sync-reload">Recharger</button>
        </div>

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <div id="scan-overlay" class="scan-overlay">
    <div class="scan-modal">
      <div class="scan-modal-header">
        <strong id="scan-modal-title">Camera scan</strong>
        <button type="button" id="scan-close">Fermer</button>
      </div>
      <video id="scan-video" class="scan-video" playsinline></video>
      <div class="scan-help" id="scan-status">Scan en cours...</div>
      <div class="scan-modal-actions">
        <button type="button" id="scan-capture" class="scan-scan-btn">Capturer texte</button>
      </div>
    </div>
  </div>

  <script src="{% static 'scan/scan.js' %}"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register("{% url 'scan:scan_service_worker' %}")
        .then(function(registration) {
          if (registration.update) {
            registration.update();
          }
          registration.addEventListener('updatefound', function() {
            var newWorker = registration.installing;
            if (!newWorker) {
              return;
            }
            newWorker.addEventListener('statechange', function() {
              if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                window.location.reload();
              }
            });
          });
        });
    }
  </script>
</body>
</html>
