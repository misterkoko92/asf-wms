{% extends "scan/base.html" %}

{% block title %}WMS Scan - Vue stock{% endblock %}

{% block content %}
  <div class="scan-card card border-0 ui-comp-card">
    <h2 class="h4 mb-3 ui-comp-title">Vue stock</h2>
    <form method="get" class="scan-filters row g-3 ui-comp-form">
      <div class="scan-field col-12 col-md-6 col-xl-3">
        <label class="form-label" for="id_q">Recherche</label>
        <input type="text" class="form-control" id="id_q" name="q" value="{{ query }}" placeholder="Nom, r&eacute;f&eacute;rence, code-barres">
      </div>

      <div class="scan-field col-12 col-md-6 col-xl-3">
        <label class="form-label" for="id_category">Cat&eacute;gorie</label>
        <div class="scan-inline">
          <select id="id_category" name="category" class="form-select">
            <option value="">Toutes cat&eacute;gories</option>
            {% for category in categories %}
              <option value="{{ category.id }}" {% if category_id == category.id|stringformat:"s" %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
          </select>
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_productcategory_add' %}" target="_blank" rel="noopener">
            Ajouter cat&eacute;gorie
          </a>
        </div>
      </div>

      <div class="scan-field col-12 col-md-6 col-xl-3">
        <label class="form-label" for="id_warehouse">Entrep&ocirc;t</label>
        <div class="scan-inline">
          <select id="id_warehouse" name="warehouse" class="form-select">
            <option value="">Tous entrep&ocirc;ts</option>
            {% for warehouse in warehouses %}
              <option value="{{ warehouse.id }}" {% if warehouse_id == warehouse.id|stringformat:"s" %}selected{% endif %}>{{ warehouse.name }}</option>
            {% endfor %}
          </select>
          <a class="scan-scan-btn btn btn-outline-primary" href="{% url 'admin:wms_warehouse_add' %}" target="_blank" rel="noopener">
            Ajouter entrep&ocirc;t
          </a>
        </div>
      </div>

      <div class="scan-field col-12 col-md-6 col-xl-3">
        <label class="form-label" for="id_sort">Tri</label>
        <select id="id_sort" name="sort" class="form-select">
          <option value="category" {% if sort == "category" %}selected{% endif %}>Cat&eacute;gorie</option>
          <option value="name" {% if sort == "name" %}selected{% endif %}>Nom</option>
          <option value="sku" {% if sort == "sku" %}selected{% endif %}>R&eacute;f&eacute;rence</option>
          <option value="qty_asc" {% if sort == "qty_asc" %}selected{% endif %}>Stock croissant</option>
          <option value="qty_desc" {% if sort == "qty_desc" %}selected{% endif %}>Stock d&eacute;croissant</option>
        </select>
      </div>
      <div class="scan-field col-12 col-md-6 col-xl-3 d-flex flex-column justify-content-end">
        <div class="scan-switch-card mt-2">
          <div class="form-check form-switch">
            <input
              type="checkbox"
              id="id_include_zero"
              name="include_zero"
              value="1"
              class="form-check-input"
              {% if include_zero %}checked{% endif %}
            >
            <label class="form-check-label" for="id_include_zero">
              Inclure les produits avec stock &agrave; 0
            </label>
          </div>
        </div>
      </div>

      <div class="scan-filter-actions col-12 d-flex flex-wrap gap-2 align-items-center ui-comp-actions">
        <button type="submit" class="scan-submit secondary scan-submit-inline btn btn-primary">Filtrer</button>
        <a class="btn btn-outline-secondary" href="{% url 'scan:scan_stock' %}">R&eacute;initialiser</a>
      </div>
    </form>
  </div>

  <div class="scan-card card border-0 ui-comp-card">
    <h2 class="h4 mb-3 ui-comp-title d-flex align-items-center gap-2 flex-wrap">
      {% if include_zero %}Produits{% else %}Produits en stock{% endif %}
      <span class="badge text-bg-light ui-comp-count-badge">{{ products|length }}</span>
    </h2>
    {% if products %}
      <div class="scan-table-wrap table-responsive">
        <table class="scan-table table table-sm table-hover" data-table-tools="1">
          <thead>
            <tr>
              <th>R&eacute;f&eacute;rence</th>
              <th>Produit</th>
              <th>Cat&eacute;gorie</th>
              <th>Stock</th>
              <th>Derni&egrave;re modification</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
              <tr>
                <td>
                  {{ product.sku }}
                  {% if product.barcode %}
                    <small>{{ product.barcode }}</small>
                  {% endif %}
                </td>
                <td>
                  {{ product.name }}
                  {% if product.brand %}
                    <small>{{ product.brand }}</small>
                  {% endif %}
                </td>
                <td>{{ product.category|default:"-" }}</td>
                <td class="qty">{{ product.stock_total }}</td>
                <td>{{ product.last_movement_at|date:"d/m/y H\\hi"|default:"-" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="scan-help ui-comp-note">
        {% if include_zero %}
          Aucun produit pour ces filtres.
        {% else %}
          Aucun produit en stock pour ces filtres.
        {% endif %}
      </p>
    {% endif %}
  </div>
{% endblock %}
