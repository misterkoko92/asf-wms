# Audit global ASF WMS (19 février 2026)

Ce document synthétise un audit transversal du repo (technique, métier, flux, admin, sécurité, dette legacy) réalisé le **19/02/2026**.

> Mise à jour de statut (post-implémentation): les phases 0, 1, 2 et 3 sont désormais livrées.
> Voir `docs/phases_0_3_recap.md` pour la synthèse consolidée et les commits de référence.

## 1) Méthode et périmètre

Audit exécuté sur l'ensemble du dépôt:

- revue code: `wms/`, `contacts/`, `api/`, `templates/`, `docs/`
- contrôles techniques:
  - `python manage.py check`
  - `python manage.py check --deploy`
  - `python manage.py makemigrations --check --dry-run`
  - `python manage.py test` (suite complète)
  - `ruff check .`
  - `mypy --config-file mypy.ini`
  - `bandit -r asf_wms api contacts wms -x ...`
  - `pip-audit -r requirements.txt` (échec tooling local)
- revue des flux métier:
  - portail association -> commande
  - commande admin -> expédition
  - scan création expédition -> suivi -> clôture
  - synchro destinataires portail -> contacts

## 2) Résultat exécutif

- Architecture globalement cohérente et riche fonctionnellement.
- Couverture de tests large (**909 tests** détectés), mais suite actuellement **rouge**.
- Dette principale: complexité de domaine contacts/portail + coexistence legacy/nouveau.
- Risque principal court terme: régressions silencieuses si release avec tests rouges.

## 3) Constats détaillés

### A. Qualité technique

Points positifs:

- `manage.py check` OK.
- migrations en phase (`makemigrations --check --dry-run` -> no changes).
- `ruff`, `mypy` (périmètre configuré), `bandit` -> OK.

Points à traiter:

- suite complète: **8 régressions** (4 erreurs, 4 échecs).
- `pip-audit` non exploitable dans l'environnement actuel (échec upgrade pip temporaire).

### B. Régressions observées (à corriger en priorité)

1. **Contacts tags / canonicalisation**
- erreurs `IntegrityError UNIQUE contacts_contacttag.name` dans:
  - `contacts/tests/tests_admin.py`
  - `contacts/tests/tests_models.py`
- cause probable: hypothèses de tests non alignées avec migrations de seed tags (`Destinataire` déjà présent).

2. **Import tags**
- `wms/tests/imports/tests_import_services_tags.py` attend 2 tags alors que base initialisée en contient déjà 1+.

3. **Portail permissions**
- `wms/tests/views/tests_views.py::PortalPermissionTests` attend 200 sur dashboard.
- nouveau comportement `association_required`: redirection 302 si aucun destinataire `is_delivery_contact=True`.

4. **Labels/accents**
- `wms/tests/carton/tests_carton_view_helpers.py` attend `"Affecte"` alors que libellé réel est `"Affecté"`.

Conclusion:

- ce sont surtout des **tests obsolètes** par rapport aux nouvelles règles métier.
- blocage release tant que la suite n'est pas repassée verte.

### C. Métier / logique / flux

Forces:

- Chaîne colis/expédition plus robuste:
  - statut carton enrichi (`labeled`)
  - synchronisation readiness expédition
  - verrouillage après planification
  - litige en overlay (`is_disputed`) + reset contrôlé.
- Flux création expédition séquencé et conforme à la logique métier cible.
- Portail associations: création commande + destinataires enrichis + synchronisation vers contacts.

Points de vigilance:

1. **Double modèle de portée destination**
- coexistence `contacts.Contact.destination` (legacy FK) + `destinations` (M2M actif).
- risque d'incohérences et de confusion.

2. **Duplication de données destinataire portail**
- `AssociationRecipient` conserve `name` + `structure_name`, `email` + `emails`, `phone` + `phones`.
- augmente les cas limites de synchronisation.

3. **Couplage fort portail <-> contacts**
- `sync_association_recipient_to_contact` applique des effets de bord (tags, destinations, linked shippers).
- fonctionnel, mais à stabiliser avec invariants explicites et tests de non-régression dédiés.

4. **Règle d'accès portail implicite**
- blocage des vues portail sans destinataire de réception actif.
- logique pertinente, mais nécessite visibilité explicite (docs, tests, UX).

### D. Admin / exploitation

Points positifs:

- Admin étendu et orienté opérations.
- Commande d'audit profils portail disponible: `audit_association_profiles`.

Points à améliorer:

- conventions de nommage tags non totalement uniformisées (`Expéditeur` vs `Expediteur`) malgré normalisation.
- gros fichiers (`wms/models.py`, `wms/admin.py`, `wms/views_scan_shipments.py`) qui ralentissent maintenance.

### E. Sécurité / conformité opérationnelle

Constat:

- `check --deploy` remonte des warnings si environnement non configuré (DEBUG/hosts/cookies/HSTS).
- côté code, les garde-fous existent dans `settings.py`, mais la conformité dépend de la config runtime.

Actions:

- imposer `check --deploy --fail-level WARNING` comme gate de déploiement réel.
- formaliser une checklist secrets/environnement unique (PythonAnywhere déjà partiellement couvert).

## 4) Plan d'amélioration et phasage

## Phase 0 - Stabilisation (immédiat, 1 à 3 jours)

Objectif: revenir à un tronc livrable et testable.

- corriger les 8 tests rouges (alignement sur nouvelles règles).
- figer une convention tags canonicalisés (normalisés, sans duplication fonctionnelle).
- valider/commiter proprement les migrations ouvertes (`0048`, `0049`) et statiques portail.
- geler toute nouvelle feature tant que la suite complète n'est pas verte.

Critère de sortie:

- `python manage.py test` 100% vert.
- `check`, `migrate-check`, `ruff`, `bandit` verts.

## Phase 1 - Durcissement métier contacts/portail (court terme, 1 à 2 semaines)

- définir une source de vérité unique pour la portée destination (`destinations` M2M).
- plan de retrait progressif de `Contact.destination` (legacy).
- simplifier le modèle `AssociationRecipient` (normaliser noms/téléphones/emails).
- verrouiller les invariants métier par tests:
  - portail -> contact sync
  - création expédition depuis commande portail
  - règles shipper/recipient/correspondent.

Mise en oeuvre (lancée):

- source de vérité destination explicitée en code via `contacts/destination_scope.py` (M2M prioritaire, FK legacy conservé en compatibilité transitoire).
- ajout de la commande `audit_contact_destinations` (audit + correction optionnelle `--apply`) pour piloter le retrait progressif du FK legacy.
- normalisation `AssociationRecipient` à l'enregistrement pour éviter les divergences de champs dupliqués.
- tests renforcés:
  - idempotence synchro portail -> contact,
  - flux E2E portail -> validation admin -> expédition préremplie.

## Phase 2 - Simplification architecture et nettoyage legacy (2 à 4 semaines)

- extraire `wms/models.py` en modules domaine (`stock`, `shipment`, `portal`, `documents`, ...).
- réduire taille de `wms/admin.py` en sous-modules par agrégat.
- formaliser les facades legacy restantes et définir date de retrait.
- homogénéiser libellés/accents et conventions FR.

Mise en oeuvre (lot 1):

- `wms/models.py` converti en façade de compatibilité.
- extraction des modèles vers `wms/models_domain/`:
  - `catalog.py`
  - `inventory.py`
  - `shipment.py`
  - `portal.py`
  - `integration.py`
- fonctions de référence conservées sur la façade `wms.models` pour compatibilité des tests et des patchs legacy.

Mise en oeuvre (lot 2):

- extraction des classes admin faiblement couplées vers `wms/admin_misc.py`.
- conservation dans `wms/admin.py` des classes sensibles aux patchs de tests (compatibilité non-régressive).
- extraction des helpers internes de `wms/views_scan_shipments.py` vers `wms/views_scan_shipments_support.py`.
- conservation des vues publiques et points de patch dans `wms/views_scan_shipments.py`.

Mise en oeuvre (lot 3):

- encadrement du suivi legacy par référence:
  - feature flag `ENABLE_SHIPMENT_TRACK_LEGACY` (désactivation possible sans changement de code)
  - journalisation explicite des accès legacy
  - headers HTTP de dépréciation/sunset sur la réponse legacy
- retrait progressif des accès destination legacy dans les exports:
  - `wms/exports.py` basculé sur `contact_destination_ids`
- homogénéisation de libellés FR/accents dans scan/admin (expéditeur, étiquettes, accès, approuvé/refusé).

## Phase 3 - Observabilité et gouvernance (continu)

- tableaux de bord techniques:
  - volume événements d'intégration email
  - expéditions en litige
  - expéditions bloquées par étape.
- journalisation métier structurée sur transitions de statuts.
- QA gates CI/CD explicites et publiés.

Mise en oeuvre:

- `scan/dashboard` enrichi avec:
  - queue email (`pending`, `processing`, `failed`, `processing` en timeout),
  - blocages workflow >72h (expéditions anciennes, commandes validées non converties, dossiers livrés non clos, litiges),
  - KPI SLA par segment (`Planifié -> OK mise à bord -> Reçu escale -> Livré`) avec ratio dépassements.
- journalisation structurée ajoutée (`logger` `wms.workflow`):
  - transitions de statut colis,
  - transitions de statut expédition (via signal de changement statut),
  - actions litige (déclaration/résolution),
  - événements de suivi et clôture de dossier.
- couverture tests renforcée sur dashboard observabilité et hooks de journalisation.

## 5) Propositions fonctionnelles V2

1. **Moteur de workflow configurable**
- transitions de statuts paramétrables (au lieu de règles codées en dur).

2. **SLA opérationnels**
- délais cibles par étape, alertes automatiques, vue des retards.

3. **Centre litiges**
- motifs normalisés, timeline d'actions, responsabilités, résolution guidée.

4. **Planification renforcée**
- liaison vols/planning, capacité, simulation de chargement.

5. **Portail destinataires avancé**
- validation documentaire par étape, visibilité de statut en temps réel par association.

6. **Traçabilité documentaire**
- versioning documents expédition et preuve de diffusion.

7. **API intégration externe v2**
- endpoints stables pour CRM, BI, outils planning.

8. **Référentiel contacts transverse (option stratégique)**
- extraction en application/service dédié multi-missions ASF, avec contrat d'échange avec WMS.

## 6) Décision recommandée

- Les phases 0 à 3 ont été exécutées.
- Prochaine étape recommandée: cadrage et phasage de la V2 (moteur de workflow, centre litiges, SLA avancés, API v2).
